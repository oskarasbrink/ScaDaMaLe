<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>998_EX_01_GraphXShortestWeightedPaths - sds-3.x/ScaDaMaLe</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../scroll-mdbook-outputs.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/010a_packageCells.html">010a_packageCells</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/011_02_IntroToSimulation.html">011_02_IntroToSimulation</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/011_03_IntroToML.html">011_03_IntroToML</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/012_UnsupervisedClustering_1MSongsKMeans_Intro.html">012_UnsupervisedClustering_1MSongsKMeans_Intro</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/013_UnsupervisedClustering_1MSongsKMeans_Stage1ETL.html">013_UnsupervisedClustering_1MSongsKMeans_Stage1ETL</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/014_UnsupervisedClustering_1MSongsKMeans_Stage2Explore.html">014_UnsupervisedClustering_1MSongsKMeans_Stage2Explore</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/015_UnsupervisedClustering_1MSongsKMeans_Stage3Model.html">015_UnsupervisedClustering_1MSongsKMeans_Stage3Model</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/016_SupervisedClustering_DecisionTrees_HandWrittenDigitRecognition.html">016_SupervisedClustering_DecisionTrees_HandWrittenDigitRecognition</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/017_LAlgIntro.html">017_LAlgIntro</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/018_LinRegIntro.html">018_LinRegIntro</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019_DistLAlgForLinRegIntro.html">019_DistLAlgForLinRegIntro</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_000_dataTypesProgGuide.html">019x_000_dataTypesProgGuide</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_001_LocalVector.html">019x_001_LocalVector</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_002_LabeledPoint.html">019x_002_LabeledPoint</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_003_LocalMatrix.html">019x_003_LocalMatrix</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_004_DistributedMatrix.html">019x_004_DistributedMatrix</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_005_RowMatrix.html">019x_005_RowMatrix</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_006_IndexedRowMatrix.html">019x_006_IndexedRowMatrix</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_007_CoordinateMatrix.html">019x_007_CoordinateMatrix</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/019x_008_BlockMatrix.html">019x_008_BlockMatrix</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/020_PowerPlantPipeline_02ModelTuneEvaluate.html">020_PowerPlantPipeline_02ModelTuneEvaluate</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/021_recognizeActivityByRandomForest.html">021_recognizeActivityByRandomForest</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/022_GraphFramesUserGuide.html">022_GraphFramesUserGuide</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/023_OnTimeFlightPerformance.html">023_OnTimeFlightPerformance</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/030_PowerPlantPipeline_03ModelTuneEvaluateDeploy.html">030_PowerPlantPipeline_03ModelTuneEvaluateDeploy</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/033_OBO_LoadExtract.html">033_OBO_LoadExtract</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/033_OBO_PipedRDD_RigorousBayesianABTesting.html">033_OBO_PipedRDD_RigorousBayesianABTesting</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/033_OBO_xx0_IvanSadikov_PipedRDDhelp.html">033_OBO_xx0_IvanSadikov_PipedRDDhelp</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/033_OBO_xx1_OBOnlineExample.html">033_OBO_xx1_OBOnlineExample</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/033_OBO_xx2_OBOnlineExampleScala.html">033_OBO_xx2_OBOnlineExampleScala</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/034_LDA_20NewsGroupsSmall.html">034_LDA_20NewsGroupsSmall</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/035_LDA_CornellMovieDialogs.html">035_LDA_CornellMovieDialogs</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/036_ALS_MovieRecommender.html">036_ALS_MovieRecommender</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/998_EX_01_GraphXShortestWeightedPaths.html" class="active">998_EX_01_GraphXShortestWeightedPaths</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_2-sds-3-x-ml/999_YT_01_FinancialFraudDetectionUsingDecisionTreeMachineLearningModels.html">999_YT_01_FinancialFraudDetectionUsingDecisionTreeMachineLearningModels</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">sds-3.x/ScaDaMaLe</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<p>ScaDaMaLe Course <a href="https://lamastex.github.io/scalable-data-science/sds/3/x/">site</a> and <a href="https://lamastex.github.io/ScaDaMaLe/index.html">book</a></p>
</div>
<div class="cell markdown">
<h1 id="extending-sparkgraphxlibshortestpaths-to-graphxshortestweightedpaths"><a class="header" href="#extending-sparkgraphxlibshortestpaths-to-graphxshortestweightedpaths">Extending spark.graphx.lib.ShortestPaths to GraphXShortestWeightedPaths</a></h1>
<h3 id="2016-2020-ivan-sadikov-and-raazesh-sainudiin"><a class="header" href="#2016-2020-ivan-sadikov-and-raazesh-sainudiin">2016-2020, Ivan Sadikov and Raazesh Sainudiin</a></h3>
<p>We extend Shortest Paths algorithm in Spark's GraphX Library to allow for user-specified edge-weights as an edge attribute.</p>
<p>This is part of <em>Project MEP: Meme Evolution Programme</em> and supported by databricks academic partners program.</p>
<p>The analysis is available in the following databricks notebook: * <a href="http://lamastex.org/lmse/mep/src/GraphXShortestWeightedPaths.html">http://lamastex.org/lmse/mep/src/GraphXShortestWeightedPaths.html</a></p>
<pre><code>Copyright 2016 Ivan Sadikov and Raazesh Sainudiin

Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
</code></pre>
</div>
<div class="cell markdown">
<h3 id="lets-modify-shortest-paths-algorithm-to-allow-for-user-specified-edge-weights"><a class="header" href="#lets-modify-shortest-paths-algorithm-to-allow-for-user-specified-edge-weights">Let's modify shortest paths algorithm to allow for user-specified edge-weights</a></h3>
<p>Update shortest paths algorithm to work over edge attribute of edge-weights as Double, key concepts are: - we increment map with delta, which is <code>edge.attr</code> - edge attribute is anything numeric, tested on Double - infinity value is not infinity, but <code>Integer.MAX_VALUE</code></p>
<p>Modifying the following code: * https://github.com/apache/spark/blob/master/graphx/src/main/scala/org/apache/spark/graphx/lib/ShortestPaths.scala</p>
<p>Explained here: * http://note.yuhc.me/2015/03/graphx-pregel-shortest-path/</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import scala.reflect.ClassTag
import org.apache.spark.graphx._

/**
 * Computes shortest weighted paths to the given set of landmark vertices, returning a graph where each
 * vertex attribute is a map containing the shortest-path distance to each reachable landmark.
 * Currently supports only Graph of [VD, Double], where VD is an arbitrary vertex type.
 */
object GraphXShortestWeightedPaths extends Serializable {
  /** Stores a map from the vertex id of a landmark to the distance to that landmark. */
  type SPMap = Map[VertexId, Double]
  // initial and infinity values, use to relax edges
  private val INITIAL = 0.0
  private val INFINITY = Int.MaxValue.toDouble

  private def makeMap(x: (VertexId, Double)*) = Map(x: _*)

  private def incrementMap(spmap: SPMap, delta: Double): SPMap = {
    spmap.map { case (v, d) =&gt; v -&gt; (d + delta) }
  }

  private def addMaps(spmap1: SPMap, spmap2: SPMap): SPMap = {
    (spmap1.keySet ++ spmap2.keySet).map {
      k =&gt; k -&gt; math.min(spmap1.getOrElse(k, INFINITY), spmap2.getOrElse(k, INFINITY))
    }.toMap
  }
  
  // at this point it does not really matter what vertex type is
  def run[VD](graph: Graph[VD, Double], landmarks: Seq[VertexId]): Graph[SPMap, Double] = {
    val spGraph = graph.mapVertices { (vid, attr) =&gt;
      // initial value for itself is 0.0 as Double
      if (landmarks.contains(vid)) makeMap(vid -&gt; INITIAL) else makeMap()
    }

    val initialMessage = makeMap()

    def vertexProgram(id: VertexId, attr: SPMap, msg: SPMap): SPMap = {
      addMaps(attr, msg)
    }

    def sendMessage(edge: EdgeTriplet[SPMap, Double]): Iterator[(VertexId, SPMap)] = {
      val newAttr = incrementMap(edge.dstAttr, edge.attr)
      if (edge.srcAttr != addMaps(newAttr, edge.srcAttr)) Iterator((edge.srcId, newAttr))
      else Iterator.empty
    }

    Pregel(spGraph, initialMessage)(vertexProgram, sendMessage, addMaps)
  }
}

println(&quot;Usage: val result = GraphXShortestWeightedPaths.run(graph, Seq(4L, 0L, 9L))&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>Usage: val result = GraphXShortestWeightedPaths.run(graph, Seq(4L, 0L, 9L))
import scala.reflect.ClassTag
import org.apache.spark.graphx._
defined object GraphXShortestWeightedPaths
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="generate-test-graph"><a class="header" href="#generate-test-graph">Generate test graph</a></h3>
<p>Generate simple graph with double weights for edges</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import scala.util.Random

import org.apache.spark.graphx.{Graph, VertexId}
import org.apache.spark.graphx.util.GraphGenerators

// A graph with edge attributes containing distances
val graph: Graph[Long, Double] = GraphGenerators.logNormalGraph(sc, numVertices = 10, seed=123L).mapEdges { e =&gt; 
  // to make things nicer we assign 0 distance to itself
  if (e.srcId == e.dstId) 0.0 else Random.nextDouble()
}
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import scala.util.Random
import org.apache.spark.graphx.{Graph, VertexId}
import org.apache.spark.graphx.util.GraphGenerators
graph: org.apache.spark.graphx.Graph[Long,Double] = org.apache.spark.graphx.impl.GraphImpl@6a98b503
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val landMarkVertexIds = Seq(4L, 0L, 9L)
val result = GraphXShortestWeightedPaths.run(graph, landMarkVertexIds)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>landMarkVertexIds: Seq[Long] = List(4, 0, 9)
result: org.apache.spark.graphx.Graph[GraphXShortestWeightedPaths.SPMap,Double] = org.apache.spark.graphx.impl.GraphImpl@763902d8
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Found shortest paths
println(result.vertices.collect.mkString(&quot;\n&quot;))
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>(4,Map(4 -&gt; 0.0, 0 -&gt; 0.4978771374144447, 9 -&gt; 0.0039659650390762025))
(0,Map(0 -&gt; 0.0, 4 -&gt; 0.6026164718020462, 9 -&gt; 0.6065824368411225))
(6,Map(0 -&gt; 0.18329441371794564, 4 -&gt; 0.7501236631976119, 9 -&gt; 0.5876411577224736))
(8,Map(0 -&gt; 1.0175525403647847, 4 -&gt; 0.8260424329285025, 9 -&gt; 0.6635599274533642))
(2,Map(0 -&gt; 0.27424380755189526, 4 -&gt; 0.43261521868768604, 9 -&gt; 0.43658118372676225))
(1,Map(0 -&gt; 0.8561112576964152, 4 -&gt; 1.4229405071760814, 9 -&gt; 1.2604580017009432))
(3,Map(0 -&gt; 0.45813682659496957, 4 -&gt; 0.2666267191586873, 9 -&gt; 0.10414421368354898))
(7,Map(4 -&gt; 0.2073486603716349, 9 -&gt; 0.04486615489649659, 0 -&gt; 0.42470420866790193))
(9,Map(9 -&gt; 0.0, 0 -&gt; 0.5045977394480895, 4 -&gt; 0.3302516601623805))
(5,Map(0 -&gt; 0.7760991789332677, 4 -&gt; 0.278222041518823, 9 -&gt; 0.2821880065578992))
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// edges with weights, make sure to check couple of shortest paths from above
result.edges.toDF.show
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+-----+-----+-------------------+
|srcId|dstId|               attr|
+-----+-----+-------------------+
|    0|    0|                0.0|
|    0|    1| 0.3685042379337995|
|    0|    4| 0.6026164718020462|
|    1|    1|                0.0|
|    1|    6| 0.6728168439784695|
|    1|    6| 0.7852936724902796|
|    2|    0|0.27424380755189526|
|    2|    1| 0.7870284262414232|
|    2|    4|0.43261521868768604|
|    2|    6| 0.3595658109787053|
|    2|    6|0.27647602206577304|
|    2|    9|  0.841095651455322|
|    3|    2| 0.1838930190430743|
|    3|    3|                0.0|
|    3|    5|0.29401237129990443|
|    3|    7|0.05927805878705239|
|    3|    8| 0.6194270974815277|
|    4|    0| 0.4978771374144447|
|    4|    3|  0.895324471945953|
|    4|    5| 0.3082168662674215|
+-----+-----+-------------------+
only showing top 20 rows
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">graph.edges.toDF.show // this is the directed weighted edge of the graph
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+-----+-----+--------------------+
|srcId|dstId|                attr|
+-----+-----+--------------------+
|    0|    0|                 0.0|
|    0|    1| 0.18179342573305257|
|    0|    4| 0.10499884753471289|
|    1|    1|                 0.0|
|    1|    6| 0.06902878615829067|
|    1|    6| 0.31916888663632115|
|    2|    0|   0.994117390558936|
|    2|    1|  0.3483496903814788|
|    2|    4|  0.6637120585508148|
|    2|    6|  0.7903591616520668|
|    2|    6| 0.15547330775766222|
|    2|    9| 0.20548813724247617|
|    3|    2| 0.30236814876856666|
|    3|    3|                 0.0|
|    3|    5|  0.8097988524182909|
|    3|    7|  0.7296892168314497|
|    3|    8|  0.7622160701710208|
|    4|    0| 0.19303017905390474|
|    4|    3| 0.09317663461190051|
|    4|    5|0.013527517923307197|
+-----+-----+--------------------+
only showing top 20 rows
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// now let us collect the shortest distance between every vertex and every landmark vertex
// to manipulate scala maps that are vertices of the result see: http://docs.scala-lang.org/overviews/collections/maps.html
// a quick point: http://stackoverflow.com/questions/28769367/scala-map-a-map-to-list-of-tuples
val shortestDistsVertex2Landmark = result.vertices.flatMap(GxSwpSPMap =&gt; {
  GxSwpSPMap._2.toSeq.map(x =&gt; (GxSwpSPMap._1, x._1, x._2)) // to get triples: vertex, landmarkVertex, shortest_distance
})
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>shortestDistsVertex2Landmark: org.apache.spark.rdd.RDD[(org.apache.spark.graphx.VertexId, org.apache.spark.graphx.VertexId, Double)] = MapPartitionsRDD[112] at flatMap at command-2971213210276591:4
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="true">
<pre><code class="language-scala">shortestDistsVertex2Landmark.collect.mkString(&quot;\n&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res6: String =
(4,4,0.0)
(4,0,0.4978771374144447)
(4,9,0.0039659650390762025)
(0,0,0.0)
(0,4,0.6026164718020462)
(0,9,0.6065824368411225)
(6,0,0.18329441371794564)
(6,4,0.7501236631976119)
(6,9,0.5876411577224736)
(8,0,1.0175525403647847)
(8,4,0.8260424329285025)
(8,9,0.6635599274533642)
(2,0,0.27424380755189526)
(2,4,0.43261521868768604)
(2,9,0.43658118372676225)
(1,0,0.8561112576964152)
(1,4,1.4229405071760814)
(1,9,1.2604580017009432)
(3,0,0.45813682659496957)
(3,4,0.2666267191586873)
(3,9,0.10414421368354898)
(7,4,0.2073486603716349)
(7,9,0.04486615489649659)
(7,0,0.42470420866790193)
(9,9,0.0)
(9,0,0.5045977394480895)
(9,4,0.3302516601623805)
(5,0,0.7760991789332677)
(5,4,0.278222041518823)
(5,9,0.2821880065578992)
</code></pre>
</div>
</div>
<div class="cell markdown">
<h4 id="lets-make-a-dataframe-for-visualizing-pairwise-matrix-plots"><a class="header" href="#lets-make-a-dataframe-for-visualizing-pairwise-matrix-plots">Let's make a DataFrame for visualizing pairwise matrix plots</a></h4>
<p>We want to make 4 columns in this example as follows (note actual values change for each realisation of graph!):</p>
<pre><code>landmark_Id1 (&quot;0&quot;),   landmarkID2 (&quot;4&quot;), landmarkId3 (&quot;9&quot;),  srcVertexId
------------------------------------------------------------------------
0.0,                  0.7425..,          0.8718,                0
0.924...,             1.2464..,          1.0472,                1
...
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// http://alvinalexander.com/scala/how-to-sort-map-in-scala-key-value-sortby-sortwith
// we need this to make sure that the maps are ordered by the keys for ensuring unique column values
import scala.collection.immutable.ListMap
import sqlContext.implicits._
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import scala.collection.immutable.ListMap
import sqlContext.implicits._
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala"> // recall our landmark vertices in landMarkVertexIds. let's use their Strings for names
val unorderedNamedLandmarkVertices = landMarkVertexIds.map(id =&gt; (id, id.toString) )
val orderedNamedLandmarkVertices = ListMap(unorderedNamedLandmarkVertices.sortBy(_._1):_*)
val orderedLandmarkVertexNames = orderedNamedLandmarkVertices.toSeq.map(x =&gt; x._2)
orderedLandmarkVertexNames.mkString(&quot;, &quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>unorderedNamedLandmarkVertices: Seq[(Long, String)] = List((4,4), (0,0), (9,9))
orderedNamedLandmarkVertices: scala.collection.immutable.ListMap[Long,String] = ListMap(0 -&gt; 0, 4 -&gt; 4, 9 -&gt; 9)
orderedLandmarkVertexNames: Seq[String] = Vector(0, 4, 9)
res7: String = 0, 4, 9
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// this is going to be our column names
val columnNames:Seq[String] = orderedLandmarkVertexNames :+ &quot;srcVertexId&quot;
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>columnNames: Seq[String] = Vector(0, 4, 9, srcVertexId)
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// a case class to make a data-frame quickly from the result
case class SeqOfDoublesAndsrcVertexId(shortestDistances: Seq[Double], srcVertexId: VertexId)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>defined class SeqOfDoublesAndsrcVertexId
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val shortestDistsSeqFromVertex2Landmark2DF = result.vertices.map(GxSwpSPMap =&gt; {
  //GxSwpSPMap._2.toSeq.map(x =&gt; (GxSwpSPMap._1, x._1, x._2)) // from before to get triples: vertex, landmarkVertex, shortest_distance
  val v = GxSwpSPMap._1
  val a = ListMap(GxSwpSPMap._2.toSeq.sortBy(_._1):_*).toSeq.map(x =&gt; x._2)
  val d = (a,v)
  d
}).map(x =&gt; SeqOfDoublesAndsrcVertexId(x._1, x._2)).toDF()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>shortestDistsSeqFromVertex2Landmark2DF: org.apache.spark.sql.DataFrame = [shortestDistances: array&lt;double&gt;, srcVertexId: bigint]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">shortestDistsSeqFromVertex2Landmark2DF.show // but this dataframe needs the first column exploded into 3 columns
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+--------------------+-----------+
|   shortestDistances|srcVertexId|
+--------------------+-----------+
|[0.49787713741444...|          4|
|[0.0, 0.602616471...|          0|
|[0.18329441371794...|          6|
|[1.01755254036478...|          8|
|[0.27424380755189...|          2|
|[0.85611125769641...|          1|
|[0.45813682659496...|          3|
|[0.42470420866790...|          7|
|[0.50459773944808...|          9|
|[0.77609917893326...|          5|
+--------------------+-----------+
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Now we want to make separate columns for each distance in the Sequence in column 'shortestDistances'.</p>
<p>Let us use the following ideas for this: * https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/3741049972324885/2662535171379268/4413065072037724/latest.html</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// this is from https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/3741049972324885/2662535171379268/4413065072037724/latest.html
import org.apache.spark.sql.{Column, DataFrame}
import org.apache.spark.sql.functions.{lit, udf}

// UDF to extract i-th element from array column
//val elem = udf((x: Seq[Int], y: Int) =&gt; x(y))
val elem = udf((x: Seq[Double], y: Int) =&gt; x(y)) // modified for Sequence of Doubles

// Method to apply 'elem' UDF on each element, requires knowing length of sequence in advance
def split(col: Column, len: Int): Seq[Column] = {
  for (i &lt;- 0 until len) yield { elem(col, lit(i)).as(s&quot;$col($i)&quot;) }
}

// Implicit conversion to make things nicer to use, e.g. 
// select(Column, Seq[Column], Column) is converted into select(Column*) flattening sequences
implicit class DataFrameSupport(df: DataFrame) {
  def select(cols: Any*): DataFrame = {
    var buffer: Seq[Column] = Seq.empty
    for (col &lt;- cols) {
      if (col.isInstanceOf[Seq[_]]) {
        buffer = buffer ++ col.asInstanceOf[Seq[Column]]
      } else {
        buffer = buffer :+ col.asInstanceOf[Column]
      }
    }
    df.select(buffer:_*)
  }
}
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import org.apache.spark.sql.{Column, DataFrame}
import org.apache.spark.sql.functions.{lit, udf}
elem: org.apache.spark.sql.expressions.UserDefinedFunction = SparkUserDefinedFunction($Lambda$6726/1752149086@9f2dc3d,DoubleType,List(Some(class[value[0]: array&lt;double&gt;]), Some(class[value[0]: int])),Some(class[value[0]: double]),None,false,true)
split: (col: org.apache.spark.sql.Column, len: Int)Seq[org.apache.spark.sql.Column]
defined class DataFrameSupport
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val shortestDistsFromVertex2Landmark2DF = shortestDistsSeqFromVertex2Landmark2DF.select(split($&quot;shortestDistances&quot;, 3), $&quot;srcVertexId&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>shortestDistsFromVertex2Landmark2DF: org.apache.spark.sql.DataFrame = [shortestDistances(0): double, shortestDistances(1): double ... 2 more fields]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">shortestDistsFromVertex2Landmark2DF.show
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+-------------------+-------------------+--------------------+-----------+
|                  0|                  4|                   9|srcVertexId|
+-------------------+-------------------+--------------------+-----------+
| 0.4978771374144447|                0.0|0.003965965039076...|          4|
|                0.0| 0.6026164718020462|  0.6065824368411225|          0|
|0.18329441371794564| 0.7501236631976119|  0.5876411577224736|          6|
| 1.0175525403647847| 0.8260424329285025|  0.6635599274533642|          8|
|0.27424380755189526|0.43261521868768604| 0.43658118372676225|          2|
| 0.8561112576964152| 1.4229405071760814|  1.2604580017009432|          1|
|0.45813682659496957| 0.2666267191586873| 0.10414421368354898|          3|
|0.42470420866790193| 0.2073486603716349| 0.04486615489649659|          7|
| 0.5045977394480895| 0.3302516601623805|                 0.0|          9|
| 0.7760991789332677|  0.278222041518823|  0.2821880065578992|          5|
+-------------------+-------------------+--------------------+-----------+
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// now let's give it our names based on the landmark vertex Ids
val shortestDistsFromVertex2Landmark2DF = shortestDistsSeqFromVertex2Landmark2DF.select(split($&quot;shortestDistances&quot;, 3), $&quot;srcVertexId&quot;).toDF(columnNames:_*)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>shortestDistsFromVertex2Landmark2DF: org.apache.spark.sql.DataFrame = [0: double, 4: double ... 2 more fields]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">shortestDistsFromVertex2Landmark2DF.show
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+-------------------+-------------------+--------------------+-----------+
|                  0|                  4|                   9|srcVertexId|
+-------------------+-------------------+--------------------+-----------+
| 0.4978771374144447|                0.0|0.003965965039076...|          4|
|                0.0| 0.6026164718020462|  0.6065824368411225|          0|
|0.18329441371794564| 0.7501236631976119|  0.5876411577224736|          6|
| 1.0175525403647847| 0.8260424329285025|  0.6635599274533642|          8|
|0.27424380755189526|0.43261521868768604| 0.43658118372676225|          2|
| 0.8561112576964152| 1.4229405071760814|  1.2604580017009432|          1|
|0.45813682659496957| 0.2666267191586873| 0.10414421368354898|          3|
|0.42470420866790193| 0.2073486603716349| 0.04486615489649659|          7|
| 0.5045977394480895| 0.3302516601623805|                 0.0|          9|
| 0.7760991789332677|  0.278222041518823|  0.2821880065578992|          5|
+-------------------+-------------------+--------------------+-----------+
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(shortestDistsFromVertex2Landmark2DF.select($&quot;0&quot;,$&quot;4&quot;,$&quot;9&quot;))
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>0</th>
<th>4</th>
<th>9</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.4978771374144447</td>
<td>0.0</td>
<td>3.9659650390762025e-3</td>
</tr>
<tr class="even">
<td>0.0</td>
<td>0.6026164718020462</td>
<td>0.6065824368411225</td>
</tr>
<tr class="odd">
<td>0.18329441371794564</td>
<td>0.7501236631976119</td>
<td>0.5876411577224736</td>
</tr>
<tr class="even">
<td>1.0175525403647847</td>
<td>0.8260424329285025</td>
<td>0.6635599274533642</td>
</tr>
<tr class="odd">
<td>0.27424380755189526</td>
<td>0.43261521868768604</td>
<td>0.43658118372676225</td>
</tr>
<tr class="even">
<td>0.8561112576964152</td>
<td>1.4229405071760814</td>
<td>1.2604580017009432</td>
</tr>
<tr class="odd">
<td>0.45813682659496957</td>
<td>0.2666267191586873</td>
<td>0.10414421368354898</td>
</tr>
<tr class="even">
<td>0.42470420866790193</td>
<td>0.2073486603716349</td>
<td>4.486615489649659e-2</td>
</tr>
<tr class="odd">
<td>0.5045977394480895</td>
<td>0.3302516601623805</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>0.7760991789332677</td>
<td>0.278222041518823</td>
<td>0.2821880065578992</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../contents/000_2-sds-3-x-ml/036_ALS_MovieRecommender.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../contents/000_2-sds-3-x-ml/999_YT_01_FinancialFraudDetectionUsingDecisionTreeMachineLearningModels.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../contents/000_2-sds-3-x-ml/036_ALS_MovieRecommender.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../contents/000_2-sds-3-x-ml/999_YT_01_FinancialFraudDetectionUsingDecisionTreeMachineLearningModels.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
