<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>02_vqa_model_inference - sds-3.x/ScaDaMaLe</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../scroll-mdbook-outputs.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Projects</li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/00_Introduction.html"><strong aria-hidden="true">1.</strong> student-project-01_group-GraphOfWiki_00_Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/01_DataLoading_redirectsTable.html"><strong aria-hidden="true">1.1.</strong> 01_DataLoading_redirectsTable</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/02_DataLoading_pagesTable.html"><strong aria-hidden="true">1.2.</strong> 02_DataLoading_pagesTable</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/03_DataLoading_pagelinksTable.html"><strong aria-hidden="true">1.3.</strong> 03_DataLoading_pagelinksTable</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/04_DataLoading_categorylinksTable.html"><strong aria-hidden="true">1.4.</strong> 04_DataLoading_categorylinksTable</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/05_DataLoading_categoryTable.html"><strong aria-hidden="true">1.5.</strong> 05_DataLoading_categoryTable</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/06_redirectRemoval.html"><strong aria-hidden="true">1.6.</strong> 06_redirectRemoval</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/07_createArticleGraph.html"><strong aria-hidden="true">1.7.</strong> 07_createArticleGraph</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/08_explorationArticleGraph.html"><strong aria-hidden="true">1.8.</strong> 08_explorationArticleGraph</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/09_fullGraphAnalysis.html"><strong aria-hidden="true">1.9.</strong> 09_fullGraphAnalysis</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/10_explorativeMotifs.html"><strong aria-hidden="true">1.10.</strong> 10_explorativeMotifs</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/11_conclusionDiscussionAndFutureWork.html"><strong aria-hidden="true">1.11.</strong> 11_conclusionDiscussionAndFutureWork</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/12_gameNotebookSetup.html"><strong aria-hidden="true">1.12.</strong> 12_gameNotebookSetup</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-01_group-GraphOfWiki/student-project-01_group-GraphOfWiki/13_gameNotebook.html"><strong aria-hidden="true">1.13.</strong> 13_gameNotebook</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-02_group-DDLOfVision/student-project-02_group-DDLOfVision/00_vqa_introduction.html"><strong aria-hidden="true">2.</strong> student-project-02_group-DDLOfVision_00_vqa_introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-02_group-DDLOfVision/student-project-02_group-DDLOfVision/01_vqa_model_training.html"><strong aria-hidden="true">2.1.</strong> 01_vqa_model_training</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-02_group-DDLOfVision/student-project-02_group-DDLOfVision/02_vqa_model_inference.html" class="active"><strong aria-hidden="true">2.2.</strong> 02_vqa_model_inference</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/00_ingest_data.html"><strong aria-hidden="true">3.</strong> student-project-03_group-WikiKG2_00_ingest_data</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/01_fetch_descriptions.html"><strong aria-hidden="true">3.1.</strong> 01_fetch_descriptions</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/02_load_data.html"><strong aria-hidden="true">3.2.</strong> 02_load_data</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/03_data_exploration.html"><strong aria-hidden="true">3.3.</strong> 03_data_exploration</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/04_analysing_relation_types.html"><strong aria-hidden="true">3.4.</strong> 04_analysing_relation_types</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/05_motif_search.html"><strong aria-hidden="true">3.5.</strong> 05_motif_search</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/06_produce_pagerank_vectors.html"><strong aria-hidden="true">3.6.</strong> 06_produce_pagerank_vectors</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/07_pagerank_for_classification.html"><strong aria-hidden="true">3.7.</strong> 07_pagerank_for_classification</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-04_group-FedMLMedicalApp/student-project-04_group-FedMLMedicalApp/00_Notebook_Presentation.html"><strong aria-hidden="true">4.</strong> student-project-04_group-FedMLMedicalApp_00_Notebook_Presentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-04_group-FedMLMedicalApp/student-project-04_group-FedMLMedicalApp/01_BrainTumorSegmentation_Centralized_Training.html"><strong aria-hidden="true">4.1.</strong> 01_BrainTumorSegmentation_Centralized_Training</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-04_group-FedMLMedicalApp/student-project-04_group-FedMLMedicalApp/02_Federated_Learning_BrainTumorSegmentation.html"><strong aria-hidden="true">4.2.</strong> 02_Federated_Learning_BrainTumorSegmentation</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-04_group-FedMLMedicalApp/student-project-04_group-FedMLMedicalApp/data_upload_test.html"><strong aria-hidden="true">4.3.</strong> data_upload_test</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-05_group-DistOpt/student-project-05_group-DistOpt/00_introduction.html"><strong aria-hidden="true">5.</strong> student-project-05_group-DistOpt_00_introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-05_group-DistOpt/student-project-05_group-DistOpt/01_Bayesian_optimization.html"><strong aria-hidden="true">5.1.</strong> 01_Bayesian_optimization</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-05_group-DistOpt/student-project-05_group-DistOpt/02_Gaussian_processes.html"><strong aria-hidden="true">5.2.</strong> 02_Gaussian_processes</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-05_group-DistOpt/student-project-05_group-DistOpt/03_acquisition_functions.html"><strong aria-hidden="true">5.3.</strong> 03_acquisition_functions</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-05_group-DistOpt/student-project-05_group-DistOpt/04_scalable_Bayesian_optimization.html"><strong aria-hidden="true">5.4.</strong> 04_scalable_Bayesian_optimization</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-05_group-DistOpt/student-project-05_group-DistOpt/05_implementation_documentation.html"><strong aria-hidden="true">5.5.</strong> 05_implementation_documentation</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-05_group-DistOpt/student-project-05_group-DistOpt/06_our_implementation.html"><strong aria-hidden="true">5.6.</strong> 06_our_implementation</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-05_group-DistOpt/student-project-05_group-DistOpt/07_additional_code.html"><strong aria-hidden="true">5.7.</strong> 07_additional_code</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-07_group-ExpsZerOInit/student-project-07_group-ExpsZerOInit/00_introduction_resnet.html"><strong aria-hidden="true">6.</strong> student-project-07_group-ExpsZerOInit_00_introduction_resnet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-07_group-ExpsZerOInit/student-project-07_group-ExpsZerOInit/01_transformer.html"><strong aria-hidden="true">6.1.</strong> 01_transformer</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-07_group-ExpsZerOInit/student-project-07_group-ExpsZerOInit/02_ddpm.html"><strong aria-hidden="true">6.2.</strong> 02_ddpm</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-08_group-WikiSearch/student-project-08_group-WikiSearch/00_Introduction.html"><strong aria-hidden="true">7.</strong> student-project-08_group-WikiSearch_00_Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-08_group-WikiSearch/student-project-08_group-WikiSearch/01_InputParsing.html"><strong aria-hidden="true">7.1.</strong> 01_InputParsing</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-08_group-WikiSearch/student-project-08_group-WikiSearch/02_PageRank.html"><strong aria-hidden="true">7.2.</strong> 02_PageRank</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-08_group-WikiSearch/student-project-08_group-WikiSearch/03_QuerySearch.html"><strong aria-hidden="true">7.3.</strong> 03_QuerySearch</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-09_group-DistEnsembles/student-project-09_group-DistEnsembles/00_Introduction.html"><strong aria-hidden="true">8.</strong> student-project-09_group-DistEnsembles_00_Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-09_group-DistEnsembles/student-project-09_group-DistEnsembles/01_Human_Pose_Data.html"><strong aria-hidden="true">8.1.</strong> 01_Human_Pose_Data</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-09_group-DistEnsembles/student-project-09_group-DistEnsembles/02_Ensemble_Training.html"><strong aria-hidden="true">8.2.</strong> 02_Ensemble_Training</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-09_group-DistEnsembles/student-project-09_group-DistEnsembles/03_Ensemble_Evaluation.html"><strong aria-hidden="true">8.3.</strong> 03_Ensemble_Evaluation</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-09_group-DistEnsembles/student-project-09_group-DistEnsembles/099_extra_Ensemble.html"><strong aria-hidden="true">8.4.</strong> 099_extra_Ensemble</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-10_group-RDI/student-project-10_group-RDI/00_introduction.html"><strong aria-hidden="true">9.</strong> student-project-10_group-RDI_00_introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-10_group-RDI/student-project-10_group-RDI/01_prepare_data.html"><strong aria-hidden="true">9.1.</strong> 01_prepare_data</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-10_group-RDI/student-project-10_group-RDI/02_baseline.html"><strong aria-hidden="true">9.2.</strong> 02_baseline</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-10_group-RDI/student-project-10_group-RDI/03_single_machine.html"><strong aria-hidden="true">9.3.</strong> 03_single_machine</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-10_group-RDI/student-project-10_group-RDI/04_distributed_learning.html"><strong aria-hidden="true">9.4.</strong> 04_distributed_learning</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-11_group-CollaborativeFiltering/student-project-11_group-CollaborativeFiltering/01_Introduction.html"><strong aria-hidden="true">10.</strong> student-project-11_group-CollaborativeFiltering_01_Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-11_group-CollaborativeFiltering/student-project-11_group-CollaborativeFiltering/02_AlgorithmsBeyondALS.html"><strong aria-hidden="true">10.1.</strong> 02_AlgorithmsBeyondALS</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-11_group-CollaborativeFiltering/student-project-11_group-CollaborativeFiltering/03_Implementation.html"><strong aria-hidden="true">10.2.</strong> 03_Implementation</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-12_group-FedLearnOpt/student-project-12_group-FedLearnOpt/01_Federated_Learning_Introduction.html"><strong aria-hidden="true">11.</strong> student-project-12_group-FedLearnOpt_01_Federated_Learning_Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-12_group-FedLearnOpt/student-project-12_group-FedLearnOpt/02_Horovod_Introduction.html"><strong aria-hidden="true">11.1.</strong> 02_Horovod_Introduction</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-12_group-FedLearnOpt/student-project-12_group-FedLearnOpt/03_Implementations.html"><strong aria-hidden="true">11.2.</strong> 03_Implementations</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-project-13_group-DRL/student-project-13_group-DRL/00_DistributedRL.html"><strong aria-hidden="true">12.</strong> student-project-13_group-DRL_00_DistributedRL</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../../contents/student-project-14_group-EarthObs/student-project-14_group-EarthObs/00_Introduction.html"><strong aria-hidden="true">13.</strong> student-project-14_group-EarthObs_00_Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../contents/student-project-14_group-EarthObs/student-project-14_group-EarthObs/01_Download_data.html"><strong aria-hidden="true">13.1.</strong> 01_Download_data</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-14_group-EarthObs/student-project-14_group-EarthObs/02_Image_preprocessing.html"><strong aria-hidden="true">13.2.</strong> 02_Image_preprocessing</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-14_group-EarthObs/student-project-14_group-EarthObs/03_Model_Architecture_and_Training.html"><strong aria-hidden="true">13.3.</strong> 03_Model_Architecture_and_Training</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-14_group-EarthObs/student-project-14_group-EarthObs/04_Prediction_And_Visualisation.html"><strong aria-hidden="true">13.4.</strong> 04_Prediction_And_Visualisation</a></li><li class="chapter-item expanded "><a href="../../../contents/student-project-14_group-EarthObs/student-project-14_group-EarthObs/05_Conclusions.html"><strong aria-hidden="true">13.5.</strong> 05_Conclusions</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../../contents/student-projects-BrIntSuSvConclusion/student-projects-BrIntSuSvConclusion/BrIntSuSv.html"><strong aria-hidden="true">14.</strong> student-projects-BrIntSuSvConclusion_BrIntSuSv</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../../editors.html"><strong aria-hidden="true">15.</strong> Editors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">sds-3.x/ScaDaMaLe</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<h1 id="model-inference"><a class="header" href="#model-inference">Model Inference</a></h1>
</div>
<div class="cell markdown">
<p>In this section, we visualize the training progress of our VQA model. We saved checkpoints containing some training statistics and model parameters. We process the checkpoints in a distributed and scalable manner using Pyspark and visualize the results. Then, we load the checkpoint that produced the best validation accuracy. We implemented an inference function that uses Horovod to perform inference in a distributed manner. We visualize a few examples of our model predictions to see where it predicted correctly and where it failed.</p>
</div>
<div class="cell markdown">
<h3 id="imports"><a class="header" href="#imports">Imports</a></h3>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">import torch
import os
import matplotlib.pyplot as plt
from collections import namedtuple
from functools import partial, update_wrapper
import json
from tqdm.notebook import tqdm
import numpy as np
import os
from pathlib import Path

import torch
import transformers
from torch.utils.data import Dataset, DataLoader
from transformers import AlbertTokenizer, AlbertModel
from transformers import ViTFeatureExtractor, ViTModel
from torch.nn import TransformerEncoder, TransformerEncoderLayer
from PIL import Image
import horovod.torch as hvd
from sparkdl import HorovodRunner
</code></pre>
</div>
<div class="cell markdown">
<h3 id="fetching-training-statistics-from-checkpoints"><a class="header" href="#fetching-training-statistics-from-checkpoints">Fetching training statistics from checkpoints</a></h3>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">checkpoints_dir = &quot;/dbfs/ml/VQA/outputs/&quot;

def get_stats_from_checkpoint(checkpoint_path):
    state_dict = torch.load(checkpoint_path, map_location=&quot;cpu&quot;)
    return {'epoch': [state_dict['epoch'],], 'train_accuracy': [100*state_dict['train_accuracy'],], 
            'val_accuracy': [100*state_dict['val_accuracy'],], 'loss': [state_dict['loss'],]}

rdd = sc.parallelize(list(range(50)))
train_stats = rdd.map(lambda x: os.path.join(checkpoints_dir, f&quot;checkpoint_{x}.pth&quot;))
train_stats = train_stats.filter(lambda x: os.path.exists(x))
train_stats = train_stats.map(lambda x: get_stats_from_checkpoint(x))
train_stats = train_stats.reduce(lambda x, y: {&quot;epoch&quot;: x[&quot;epoch&quot;] + y[&quot;epoch&quot;], 
                                               &quot;train_accuracy&quot;: x[&quot;train_accuracy&quot;] + y[&quot;train_accuracy&quot;], 
                                               &quot;val_accuracy&quot;: x[&quot;val_accuracy&quot;] + y[&quot;val_accuracy&quot;],
                                               &quot;loss&quot;: x[&quot;loss&quot;] + y[&quot;loss&quot;]})
train_stats
</code></pre>
</div>
<div class="cell markdown">
<h3 id="training-and-validation-progress"><a class="header" href="#training-and-validation-progress">Training and validation progress</a></h3>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">fig, ax = plt.subplots(1, 1, figsize=(10, 5))
best_val_accuracy = np.max(train_stats[&quot;val_accuracy&quot;])
best_epoch = train_stats[&quot;epoch&quot;][np.argmax(train_stats[&quot;val_accuracy&quot;])]
_ = ax.plot(train_stats[&quot;epoch&quot;], train_stats[&quot;train_accuracy&quot;])
_ = ax.plot(train_stats[&quot;epoch&quot;], train_stats[&quot;val_accuracy&quot;])
_ = ax.legend([&quot;Training&quot;, &quot;Validation&quot;])
_ = ax.set_xlabel(&quot;Epoch&quot;)
_ = ax.set_ylabel(&quot;Accuracy&quot;)
_ = ax.set_title(&quot;VQA model accuracy&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">print(f&quot;Best validation accuracy of {best_val_accuracy} was reached at epoch {best_epoch}&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">best_epoch = 13
best_checkpoint_path = f&quot;/dbfs/ml/VQA/outputs/checkpoint_{best_epoch-1}.pth&quot;
state_dict = torch.load(best_checkpoint_path, map_location=&quot;cpu&quot;)
print(f&quot;Loaded best checkpoint from epoch {state_dict['epoch']}, observed validation accuracy = {state_dict['val_accuracy']}&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">def collator_f(batch, txt_tokenizer):
    txt = [ex['txt'] for ex in batch]
    encoded_txt = txt_tokenizer(txt, padding=True, return_tensors=&quot;pt&quot;, return_attention_mask=True)
    label = torch.FloatTensor([ex['label'] for ex in batch])
    encoded_img = {'pixel_values': torch.stack([ex['encoded_img']['pixel_values'][0] for ex in batch])}
    
    return {'txt': txt, 'encoded_txt': encoded_txt, 'label': label, 'encoded_img': encoded_img}


class VQADatset(Dataset):
    def __init__(self, txt_tokenizer, data_split=&quot;train&quot;):
        # Loading the tokenizer and image feature extractor
        self.txt_tokenizer = txt_tokenizer 
        self.img_feat_extractor = ViTFeatureExtractor.from_pretrained('facebook/dino-vits16')
        self.data_split = data_split
        
        # Get ready the text
        if self.data_split==&quot;train&quot;:
            self.questions = json.load(open('/dbfs/ml/VQA/MultipleChoice_mscoco_train2014_questions.json'))['questions']
            self.answers = json.load(open('/dbfs/ml/VQA/mscoco_train2014_annotations.json'))['annotations']
        else:
            self.questions = json.load(open('/dbfs/ml/VQA/MultipleChoice_mscoco_val2014_questions.json'))['questions']
            self.answers = json.load(open('/dbfs/ml/VQA/mscoco_val2014_annotations.json'))['annotations']
        self.yesno_indices = [i for i, a in enumerate(self.answers) if a[&quot;answer_type&quot;] == &quot;yes/no&quot;]
        self.questions = [self.questions[i] for i in self.yesno_indices]
        self.answers = [self.answers[i] for i in self.yesno_indices]
        
    def __len__(self):
        return len(self.questions)
    
    def __getitem__(self, idx):
        question = self.questions[idx]
        answer = self.answers[idx]
        
        assert question['question_id'] == answer['question_id']
        
        txt = question['question']
        assert len(question['multiple_choices']) == 18
        label = 1 if answer['multiple_choice_answer'] == &quot;yes&quot; else 0
        img_id = question['image_id']
        img = Image.open(f'/dbfs/ml/VQA/{self.data_split}2014/COCO_{self.data_split}2014_{img_id:012}.jpg')

        try:
            encoded_img = self.img_feat_extractor(images=img, return_tensors=&quot;pt&quot;)
        except:
            encoded_img = self.img_feat_extractor(images=img.convert('RGB'), return_tensors=&quot;pt&quot;)
        
        return {'txt': txt, 'encoded_txt': '', 'label': label, 'encoded_img': encoded_img}
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">class VQAModel(torch.nn.Module):
    def __init__(self, d_model: int=384, nhead: int=6, d_hid: int=384, nlayers: int=1, n_class: int=1):
        super(VQAModel, self).__init__()
        
        # Loading the encoders
        self.albert = AlbertModel.from_pretrained(&quot;albert-base-v2&quot;)
        self.vit = ViTModel.from_pretrained('facebook/dino-vits16', add_pooling_layer=False)
        
        # Freeze them
        self.vit.eval()
        self.albert.eval()
        for param in self.albert.parameters():
            param.requires_grad = False
        
        for param in self.vit.parameters():
            param.requires_grad = False

        # A linear layer to map Albert to ViT size
        self.linear_map = torch.nn.Sequential(torch.nn.Linear(768, d_hid), torch.nn.GELU())
        self.linear_map_img = torch.nn.Sequential(torch.nn.Linear(d_hid, d_hid), torch.nn.GELU())
  
        # The multimodal transformer block
        encoder_layer = TransformerEncoderLayer(d_model, nhead, d_hid)
        self.transformer_encoder = TransformerEncoder(encoder_layer, nlayers)

        # A linear layer for classification
        self.linear_cls = torch.nn.Sequential(torch.nn.Linear(4*d_hid, d_hid//4), torch.nn.GELU(), torch.nn.Linear(d_hid//4, n_class), torch.nn.GELU())

    def set_eval(self):
        self.linear_map.eval()
        self.linear_map_img.eval()
        self.transformer_encoder.eval()
        self.linear_cls.eval()

    def set_train(self):
        self.linear_map.train()
        self.linear_map_img.train()
        self.transformer_encoder.train()
        self.linear_cls.train()
        
    def forward(self, encoded_txt, encoded_img):
        txt_out = self.albert(**encoded_txt).last_hidden_state
        txt_out = self.linear_map(txt_out)
        img_out = self.vit(**encoded_img).last_hidden_state
        img_out = self.linear_map_img(img_out)
        txt_img = torch.cat((txt_out, img_out), dim=-2)
        txt_img = self.transformer_encoder(txt_img)
        attention_mask = encoded_txt.attention_mask[:, 1:].unsqueeze(-1)
        txt_img_features = torch.cat([txt_img[:,0], txt_img[:,txt_out.shape[1]], 
                                      torch.sum(txt_img[:, 1:txt_out.shape[1]] * attention_mask, dim=-2) / torch.sum(attention_mask, dim=-2), 
                                      torch.mean(txt_img[:, txt_out.shape[1]:], dim=-2)], dim=-1)
        pred = self.linear_cls(txt_img_features)
        return pred
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python"># Load best model for inference
device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
txt_tokenizer = AlbertTokenizer.from_pretrained('albert-base-v2')
model = VQAModel()
msg = model.load_state_dict(state_dict[&quot;state_dict&quot;])
model.eval()
print(f&quot;Model loaded successfully. {msg}&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">def predict(model, data_loader, device):
    pred_labels = []
    true_labels = []
    with torch.no_grad():
        for i, batch in enumerate(data_loader):
            if i % 25 == 0:
                print(f'Val: {int(i*100/len(data_loader))}%')
            encoded_txt = batch['encoded_txt'].to(device)
            encoded_img = {'pixel_values': batch['encoded_img']['pixel_values'].to(device)}
            pred = model(encoded_txt, encoded_img)
            pred_labels.append((pred.reshape(-1).detach().cpu() &gt; 0.0).long())
            true_labels.append(batch['label'])
    pred_labels = torch.cat(pred_labels).numpy()
    true_labels = torch.cat(true_labels).numpy()
    return pred_labels, true_labels


def inference(best_epoch, use_horovod=True):
    output_dir = &quot;/dbfs/ml/VQA/outputs/predictions/&quot;
    device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
    print(device)
    
    if use_horovod:
        hvd.init()
        if torch.cuda.is_available():
            torch.cuda.set_device(hvd.local_rank())

    txt_tokenizer = AlbertTokenizer.from_pretrained('albert-base-v2')
    dataset = VQADatset(txt_tokenizer, data_split=&quot;val&quot;)
    collator = partial(collator_f, txt_tokenizer=txt_tokenizer)
    
    best_checkpoint_path = f&quot;/dbfs/ml/VQA/outputs/checkpoint_{best_epoch-1}.pth&quot;
    state_dict = torch.load(best_checkpoint_path, map_location=&quot;cpu&quot;)
    model = VQAModel()
    model.load_state_dict(state_dict[&quot;state_dict&quot;])
    model.to(device)
    model.eval()

    if use_horovod:
        from torch.utils.data.distributed import DistributedSampler
        vqa_sampler = DistributedSampler(dataset, num_replicas=hvd.size(), rank=hvd.rank())
        vqa_dl = DataLoader(dataset, batch_size=256, shuffle=False, collate_fn=collator, num_workers=4, sampler=vqa_sampler)
        hvd.broadcast_parameters(model.state_dict(), root_rank=0)
    else:
        vqa_dl = DataLoader(dataset, batch_size=256, shuffle=False, collate_fn=collator, num_workers=4)
    
    pred_labels, true_labels = predict(model, vqa_dl, device)

    if (use_horovod and hvd.rank() == 0) or not use_horovod:

        np.save(os.path.join(output_dir, f&quot;pred_labels.npy&quot;), pred_labels)
        np.save(os.path.join(output_dir, f&quot;true_labels.npy&quot;), true_labels)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">def main_inference(use_horovod=True, np=1):
    if use_horovod:
        hr = HorovodRunner(np=np, driver_log_verbosity='all') 
        hr.run(lambda: inference(best_epoch=13, use_horovod=True))
    else:
        train(use_horovod=False)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python"># Run distributed inference using Horovod
main_inference()
</code></pre>
</div>
<div class="cell markdown">
<h3 id="visualization-of-prediction-examples"><a class="header" href="#visualization-of-prediction-examples">Visualization of prediction examples</a></h3>
</div>
<div class="cell markdown">
<p>In this section, we visualize a few examples showing where the model succeeds and fails.</p>
<p>A general observation regarding the results is that the model works resonably well at answering questions related to <strong>objects in the image</strong>. This makes sense as the visual feature extractors are known to perform well at object classification and segmentation tasks.</p>
<p>The model often fails at <strong>higher-order reasoning about images</strong> (for example, the model does not know that elephants visit a large pond when they are likely thirsty) and <strong>commonsense knowledge</strong> (like whether children like teddy bears).</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">inference_dir = &quot;/dbfs/ml/VQA/outputs/predictions/&quot;
pred_labels = np.load(os.path.join(inference_dir, &quot;pred_labels.npy&quot;))
true_labels = np.load(os.path.join(inference_dir, &quot;true_labels.npy&quot;))

txt_tokenizer = AlbertTokenizer.from_pretrained('albert-base-v2')
dataset = VQADatset(txt_tokenizer, data_split=&quot;val&quot;)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-python">true_positives = np.where((pred_labels==1) &amp; (true_labels == pred_labels))[0]
false_positives = np.where((pred_labels==1) &amp; (true_labels != pred_labels))[0]
true_negatives = np.where((pred_labels==0) &amp; (true_labels == pred_labels))[0]
false_negatives = np.where((pred_labels==0) &amp; (true_labels != pred_labels))[0]

# randomly choose 4 examples in each category
true_positives = true_positives[np.array([0,1,5,3])]
false_positives = false_positives[np.array([0,1,2,3])]
true_negatives = true_negatives[np.array([7,1,2,3])]
false_negatives = false_negatives[np.array([7,1,2,3])]
</code></pre>
</div>
<div class="cell markdown">
<h4 id="true-positives"><a class="header" href="#true-positives">True positives</a></h4>
</div>
<div class="cell markdown">
<p><img src="https://github.com/oskarasbrink/scalable-data-science/blob/master/images/ScaDaMaLe/2022-WASP/group-2/group-2_1.jpg?raw=true" alt="" /></p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell markdown">
<h4 id="false-positives"><a class="header" href="#false-positives">False positives</a></h4>
</div>
<div class="cell markdown">
<p><img src="https://github.com/oskarasbrink/scalable-data-science/blob/master/images/ScaDaMaLe/2022-WASP/group-2/group-2_2.jpg?raw=true" alt="" /></p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell markdown">
<h4 id="true-negatives"><a class="header" href="#true-negatives">True negatives</a></h4>
</div>
<div class="cell markdown">
<p><img src="https://github.com/oskarasbrink/scalable-data-science/blob/master/images/ScaDaMaLe/2022-WASP/group-2/group-2_3.jpg?raw=true" alt="" /></p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell markdown">
<h4 id="false-negatives"><a class="header" href="#false-negatives">False negatives</a></h4>
</div>
<div class="cell markdown">
<p><img src="https://github.com/oskarasbrink/scalable-data-science/blob/master/images/ScaDaMaLe/2022-WASP/group-2/group-2_4.jpg?raw=true" alt="" /></p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../contents/student-project-02_group-DDLOfVision/student-project-02_group-DDLOfVision/01_vqa_model_training.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/00_ingest_data.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../contents/student-project-02_group-DDLOfVision/student-project-02_group-DDLOfVision/01_vqa_model_training.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../contents/student-project-03_group-WikiKG2/student-project-03_group-WikiKG2/00_ingest_data.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
