<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>042_streamingWithTDigest - sds-3.x/ScaDaMaLe</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../scroll-mdbook-outputs.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/037a_AnimalNamesStructStreamingFiles.html">037a_AnimalNamesStructStreamingFiles</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/037b_Mix2NormalsStructStreamingFiles.html">037b_Mix2NormalsStructStreamingFiles</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/037c_Mix2RandomGraphStructStreamingFiles.html">037c_Mix2RandomGraphStructStreamingFiles</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/038_StructuredStreamingProgGuide.html">038_StructuredStreamingProgGuide</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/039_StructuredStreamingFromJSONFileStream.html">039_StructuredStreamingFromJSONFileStream</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/040_Sketching.html">040_Sketching</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/040a_TDigestInputStream.html">040a_TDigestInputStream</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/041_SketchingWithTDigest.html">041_SketchingWithTDigest</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_4-sds-3-x-ss/042_streamingWithTDigest.html" class="active">042_streamingWithTDigest</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">sds-3.x/ScaDaMaLe</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<p>ScaDaMaLe Course <a href="https://lamastex.github.io/scalable-data-science/sds/3/x/">site</a> and <a href="https://lamastex.github.io/ScaDaMaLe/index.html">book</a></p>
</div>
<div class="cell markdown">
<p><strong>TODO:</strong> - Make this notebook work for latest version of isarn sketches library with lots of optimisations. - Start by learning from resources embedded in earlier notebooks on T-Digest... - This notebook should still work with Spark 2.4+ and isarn-sketches library from 2018 - Estimated time to upgrade to latest version is 1-x hours (actual time is: ? hours).</p>
</div>
<div class="cell markdown">
<h1 id="streaming-tdigest-with-flatmapgroupswithstate"><a class="header" href="#streaming-tdigest-with-flatmapgroupswithstate">Streaming TDigest with flatMapGroupsWithState</a></h1>
<p>by <a href="https://www.linkedin.com/in/benny-avelin-460b99121/">Benny Avelin</a> and <a href="https://www.linkedin.com/in/h%C3%A5kan-persson-064b763/">HÃ¥kan Persson</a>. Updated for Spark 3.0 and isarn-sketches-spark 0.5.2 by <a href="https://www.linkedin.com/in/johannes-graner-475677129/">Johannes Graner</a>.</p>
<p>The idea with this sketch is to demonstrate how we can have a running t-Digest in a streaming context.</p>
<h2 id="arbitrary-stateful-aggregations-in-streaming"><a class="header" href="#arbitrary-stateful-aggregations-in-streaming">Arbitrary stateful aggregations in streaming</a></h2>
<p>We have two stateful operations, the first is mapGroupsWithState and flatmapGroupsWithState. The Databricks blog have a relatively good explanation of the two operations in their blogpost https://databricks.com/blog/2017/10/17/arbitrary-stateful-processing-in-apache-sparks-structured-streaming.html. However the concept is maybe not so easy to understand so I will try to give a simple explanation of what is going on with these two aggregations.</p>
<h3 id="structured-streaming"><a class="header" href="#structured-streaming">Structured streaming</a></h3>
<p>For the purpose of this sketch we only need to know that new data will arrive as a batch, if we instead of a streaming dataframe just apply the aggregations on a dataframe then the entirety of the data will be in a single batch.</p>
<h3 id="a-running-state"><a class="header" href="#a-running-state">A running state</a></h3>
<p>The way both mapGroupsWithState and flatMapGroupsWithState works is that we start with a key-value grouped datasets, when new data arrives it will be split into the groups prescribed by the key and each key will get a batch of data. The main important idea to realize is that for each key we have a running state, and there is no prerestriction to witch keys are ok and not so the number of keys can grow/shrink or whatever. If a new key appears, the first step in both mapGroupsWithState and flatmap... is to initialize a zero state before processing the first batch for this key, the next time a key appears it will have remembered the previous state and we can use the previous state and the added batch of data to compute the next state. What can a state be? Well an object of some class that has been predescribed, the simplest would be a running max/min/mean but also as we will see in this sketch a t-digest.</p>
<h3 id="flatmapgroupswithstate-vs-mapgroupswithstate"><a class="header" href="#flatmapgroupswithstate-vs-mapgroupswithstate">flatmapGroupsWithState vs mapGroupsWithState</a></h3>
<p>The simple difference between these two can be infered from the name, but let us go into detail. If we are only interested in an aggregated &quot;value&quot; (could be a case class) from each key we should use mapGroupsWithState, however there are some interesting caveats with using mapGroupsWithState. For instance certain update-modes are not allowed as well as further aggregations are not allowed. flatmap... on the other hand can output any number of rows, allows more output-modes and allows for further aggregations, see the Structured Streaming programming guide.</p>
<table>
  <tr>
    <td>Query type</td><td>Output mode</td><td>Operations allowed</td>
  </tr>
  <tr>
    <td>mapGroupsWithState</td><td>Update</td><td>Aggregations not allowed</td>
  </tr>
  <tr>
    <td>flatMapGroupsWithState</td><td>Append</td><td>Aggregations allowed after</td>
  </tr>
  <tr>
    <td>flatMapGroupsWithState</td><td>Update</td><td>Aggregations not allowed</td>
  </tr>
</table>
</div>
<div class="cell markdown">
<h1 id="some-streaming-input"><a class="header" href="#some-streaming-input">Some streaming input</a></h1>
<p>We need to have a streaming source for our example, this can be done in a number of ways. Probably there is some nice way to do this simply but the few methods I know to generate test-samples is to get a running loop that writes files with data, so that each time a new file arrives Spark will consider it as an update and load it as a batch. We have provided some code to generate points sampled from a normal distribution with anomalies added as another normal distribution.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import scala.util.Random
import scala.util.Random._
import scala.util.{Success, Failure}

// make a sample to produce a mixture of two normal RVs with standard deviation 1 but with different location or mean parameters
def myMixtureOf2NormalsReg( normalLocation: Double, abnormalLocation: Double, normalWeight: Double, r: Random) : (String, Double) = {
  val sample = if (r.nextDouble &lt;= normalWeight) {r.nextGaussian+normalLocation } 
               else {r.nextGaussian + abnormalLocation} 
  Thread.sleep(5L) // sleep 5 milliseconds
  val now = (new java.text.SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;)).format(new java.util.Date())
  return (now,sample)
}
</code></pre>
</div>
<div class="cell markdown">
<h1 id="the-tmp-folder"><a class="header" href="#the-tmp-folder">The /tmp folder</a></h1>
<p>Databricks community edition has a file-number limit to 10000 and after running databricks for a while one will start to notice that things fail, and skimming the stacktrace of the failure we realize that we have reached said limit. Deleting files that one has created does not seem to solve the issue, well... this is because the /tmp folder counts into the limit and this is not cleared nearly as often as would be good for our work. Therefore we just clear it before starting our job...</p>
<p>ps. If you have not cleared the tmp folder before this might take some time actually. ds.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">dbutils.fs.rm(&quot;/datasets/streamingFiles/&quot;,true) 
//dbutils.fs.rm(&quot;/tmp&quot;,true) // this is to delete the directory before staring a job
val r = new Random(12345L)
var a = 0;
import scala.concurrent.Future
import scala.concurrent.ExecutionContext.Implicits.global
// for loop execution to write files to distributed fs
//We have made a Future out of this, which means that it runs concurrently with what we do next, i.e. essentially it is a seperate thread.

val writeStreamFuture = Future {
  for( a &lt;- 1 to 10){
    val data = sc.parallelize(Vector.fill(1000){myMixtureOf2NormalsReg(1.0, 10.0, 0.99, r)}).coalesce(1).toDF.as[(String,Double)]
    val minute = (new java.text.SimpleDateFormat(&quot;mm&quot;)).format(new java.util.Date())
    val second = (new java.text.SimpleDateFormat(&quot;ss&quot;)).format(new java.util.Date())
    data.write.mode(SaveMode.Overwrite).csv(&quot;/datasets/streamingFiles/&quot; + minute +&quot;_&quot; + second + &quot;.csv&quot;)
    Thread.sleep(5000L) // sleep 5 seconds
  }
}
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>r: scala.util.Random = scala.util.Random@2c715b75
a: Int = 0
import scala.concurrent.Future
import scala.concurrent.ExecutionContext.Implicits.global
writeStreamFuture: scala.concurrent.Future[Unit] = Future(&lt;not completed&gt;)
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;/datasets/streamingFiles&quot;))
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>path</th>
<th>name</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dbfs:/datasets/streamingFiles/05_30.csv/</td>
<td>05_30.csv/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/streamingFiles/05_41.csv/</td>
<td>05_41.csv/</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell markdown">
<h1 id="aws-eventually-consistent"><a class="header" href="#aws-eventually-consistent">AWS eventually consistent</a></h1>
<p>The AWS distributed filesystem is eventually consistent, this can mean for instance that a file just created will not be possible to read and if we are unlucky the following code will fail to run.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import org.apache.spark.sql.types._
import java.sql.{Date, Timestamp}

/**
  * timedScore is the SQL schema for timedScoreCC, and the files written in the above code
  */
val timedScore = new StructType().add(&quot;time&quot;, &quot;timestamp&quot;).add(&quot;score&quot;, &quot;Double&quot;)
case class timedScoreCC(time: Timestamp, val score: Double) {
}

val streamingLinesDS = spark
  .readStream
  .option(&quot;sep&quot;, &quot;,&quot;)
  .schema(timedScore)      // Specify schema of the csv files
  .option(&quot;MaxFilesPerTrigger&quot;, 1) //  maximum number of new files to be considered in every trigger (default: no max) 
  .csv(&quot;/datasets/streamingFiles/*&quot;).as[timedScoreCC]
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import org.apache.spark.sql.types._
import java.sql.{Date, Timestamp}
timedScore: org.apache.spark.sql.types.StructType = StructType(StructField(time,TimestampType,true), StructField(score,DoubleType,true))
defined class timedScoreCC
streamingLinesDS: org.apache.spark.sql.Dataset[timedScoreCC] = [time: timestamp, score: double]
</code></pre>
</div>
</div>
<div class="cell markdown">
<h1 id="states-and-rows"><a class="header" href="#states-and-rows">States and rows</a></h1>
<p>To begin describing the code below, let us first look at what will be our running State. The <code>isarnproject</code> sketches packs the TDigest class into a TDigestSQL case class and provides encoders for this to be allowed in a Dataframe, therefore we can capitalize on this and use TDigestSQL as our running state (to be precise it is the TDigest wrapped by TDigestSQL that is the state but whatever.). The next thing to worry about is how should we output and what should we output? This example shows how to embed in a single row, the TDigest, the threshold value that comes from <code>cdfInverse(0.99)</code> and the actual data that is above the threshold. To do this we create a case class which will be the template for our row, in the code below it is called <code>TdigAndAnomaly</code>.</p>
<h2 id="updateacrossbatch"><a class="header" href="#updateacrossbatch">updateAcrossBatch</a></h2>
<p>This is our main update-function that we send as a parameter to flatmapGroupsWithState.</p>
<ul>
<li>It takes as first input the key-value, which we will not care about in this example and is just a dummy for us.</li>
<li>The second input is the <code>inputs : Iterator[timedScoreCC]</code>, this is an iterator over the batch of data that we have recieved. This is the type-safe version, i.e. we know that we have a <code>Dataset[timedScoreCC]</code>, if we dont and we instead have a <code>DataFrame = Dataset[Row]</code>, we have to use <code>inputs : Iterator[Row]</code>, and we have to extract the columns of interest cast into the appropriate types.</li>
<li>The third input is the running state variable, this is always wrapped in a <code>GroupState</code> wrapper class, i.e. since <code>TDigestSQL</code> was our state we need to have <code>GroupState[TDigestSQL]</code> as <code>oldstate</code>.</li>
<li>Lastly we have the output, which is an iterator of the case class chosen as outputrow, in our case this is <code>Iterator[TdigAndAnomaly]</code></li>
</ul>
<p>Each time a batch gets processed, the batch data is in the <code>inputs</code> variable. We first make sure that the state is either the previous state (if it exists) or we set it to a zero state. Then we simply process the batch one datapoint at the time, and each time calling updateTDIG, which simply updates the state with the new data point (tDigest add point). Once we have added all the points to the t-Digest, we can compute the updated value of <code>threshold</code> using <code>cdfInverse(0.99)</code>, after that we simply filter the batch to obtain an iterator of the anomalies.</p>
<h3 id="groupstatetimeout"><a class="header" href="#groupstatetimeout">GroupStateTimeout</a></h3>
<p>This is an interesting variable that you really should look into if you wish to understand structured streaming. Essentially it is the whole point of messing around with the structured streaming framework, see the programming guide.</p>
</div>
<div class="cell code" execution_count="1" scrolled="true">
<pre><code class="language-scala">import java.sql.Timestamp
import org.apache.spark.sql.Encoder
import org.apache.spark.sql.catalyst.encoders.ExpressionEncoder
import org.isarnproject.sketches.spark.tdigest.infra.TDigest
import org.apache.spark.sql.streaming.{GroupStateTimeout, OutputMode, GroupState}

// Need to declare an implicit encoder in order to use the TDigest class in Datasets.
implicit val impEncoder: Encoder[TDigest] = ExpressionEncoder[TDigest]()

// State definition
case class TdigAndAnomaly(tDig:TDigest, tDigThreshold:Double, time:Timestamp, score:Double)

// Update function, takes a key, an iterator of events and a previous state, returns an iterator which represents the
// rows of the output from flatMapGroupsWithState
def updateAcrossBatch(dummy:Int, inputs: Iterator[timedScoreCC], oldState: GroupState[TDigest]):Iterator[TdigAndAnomaly] = {
  
  // state is the oldState if it exists otherwise we create an empty state to start from
  val state:TDigest = if (oldState.exists) oldState.get else new TDigest(TDigest.compressionDefault, TDigest.maxDiscreteDefault)
  
  // We copy the traversableOnce iterator inputs into inputs1 and inputs2, this implies we need to discard inputs
  val (inputs1,inputs2) = inputs.duplicate
  
  // Update the state for each input
  inputs1.foreach( input =&gt; state.update(input.score) )
  
  // Update the state for the next microbatch
  oldState.update(state)
  
  // Precompute the threshold for which we will sort the anomalies
  val cdfInv:Double = state.cdfInverse(0.99)
  
  // Yields an iterator of anomalies
  val anomalies:Iterator[TdigAndAnomaly] = for(input &lt;- inputs2; if (input.score &gt; cdfInv)) yield TdigAndAnomaly(state,cdfInv,input.time,input.score)
  
  // Return the anomalies iterator, each item in the iterator gives a row in the output
  anomalies
}

import org.apache.spark.sql.streaming.GroupStateTimeout

val query = streamingLinesDS
  .groupByKey(x =&gt; 1)
  .flatMapGroupsWithState(OutputMode.Append,GroupStateTimeout.NoTimeout)(updateAcrossBatch)
  .writeStream
  .outputMode(&quot;append&quot;)
  .format(&quot;console&quot;)
  .start
  .awaitTermination
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>-------------------------------------------
Batch: 0
-------------------------------------------
+--------------------+-----------------+--------------------+------------------+
|             tDigSql|    tDigThreshold|                time|             score|
+--------------------+-----------------+--------------------+------------------+
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...| 9.639219241219372|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...|11.539205812425335|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...| 9.423175513609095|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...|  8.99959554980265|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...|10.174199861232976|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...|10.442627838980057|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...|10.460772141286911|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...|11.260505056159252|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...| 9.905282503779972|
|TDigest(-2.005053...|7.909881933492612|2022-02-14 12:05:...| 9.102639076417908|
+--------------------+-----------------+--------------------+------------------+

-------------------------------------------
Batch: 1
-------------------------------------------
+--------------------+-----------------+--------------------+------------------+
|             tDigSql|    tDigThreshold|                time|             score|
+--------------------+-----------------+--------------------+------------------+
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 9.695132992174205|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...|10.439052640762693|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 10.02254460606071|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 9.311690918035534|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 9.454926349089147|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...|  9.87803253322451|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 9.858438409632281|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 10.45683581285141|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 9.311726779124077|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 8.994959541314255|
|TDigest(-2.314837...|8.363164394938963|2022-02-14 12:05:...| 8.577631475055892|
+--------------------+-----------------+--------------------+------------------+

-------------------------------------------
Batch: 2
-------------------------------------------
+--------------------+-----------------+--------------------+------------------+
|             tDigSql|    tDigThreshold|                time|             score|
+--------------------+-----------------+--------------------+------------------+
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...| 10.13608393266294|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...| 9.562663532092044|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...| 10.50152359072326|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...|10.061968291873699|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...|10.242131495863143|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...| 9.535096094790836|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...|11.012797937983356|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...| 9.841120163403126|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...|11.569770306228012|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...|10.947191786184677|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...|10.380284632322022|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...|10.399812080160988|
|TDigest(-2.477169...|9.185194249546218|2022-02-14 12:05:...| 10.47155413079559|
+--------------------+-----------------+--------------------+------------------+

-------------------------------------------
Batch: 3
-------------------------------------------
+--------------------+-----------------+--------------------+------------------+
|             tDigSql|    tDigThreshold|                time|             score|
+--------------------+-----------------+--------------------+------------------+
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:05:...|11.028282567178604|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:05:...| 9.801446956198197|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:05:...| 9.349642991847796|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:06:...|10.446018187089411|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:06:...|10.735315117514041|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:06:...|11.160788156092288|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:06:...| 9.741913362611065|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:06:...|10.031203472330613|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:06:...| 9.310488974576659|
|TDigest(-2.477169...|9.111097583328924|2022-02-14 12:06:...|10.669624608178813|
+--------------------+-----------------+--------------------+------------------+
</code></pre>
</div>
</div>
<div class="cell markdown">
<h1 id="have-fun"><a class="header" href="#have-fun">Have fun</a></h1>
<p>Arbitrary stateful aggregations are very powerful and you can really do a lot, especially if you are allowed to perform aggregations afterwards (flatmapGroupsWithState with Append mode). This is some really cool stuff!</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../contents/000_4-sds-3-x-ss/041_SketchingWithTDigest.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../contents/000_4-sds-3-x-ss/041_SketchingWithTDigest.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
