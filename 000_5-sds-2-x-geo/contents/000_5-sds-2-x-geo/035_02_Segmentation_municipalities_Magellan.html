<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>035_02_Segmentation_municipalities_Magellan - sds-3.x/ScaDaMaLe</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../scroll-mdbook-outputs.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/000_5-sds-2-x-geo-changes.html">000_5-sds-2-x-geo-changes</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/001_CrashCourseGIS.html">001_CrashCourseGIS</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/031_GeospatialAnalyticsInMagellan.html">031_GeospatialAnalyticsInMagellan</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/031a_MagellanOSMIngestion.html">031a_MagellanOSMIngestion</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/032_NYtaxisInMagellan.html">032_NYtaxisInMagellan</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/032a_MSR_BeijingTaxiTrajectories_MagellanQueries.html">032a_MSR_BeijingTaxiTrajectories_MagellanQueries</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/032b_UberMapMatchingAndVisualization.html">032b_UberMapMatchingAndVisualization</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/032d_MobileSampleSQL.html">032d_MobileSampleSQL</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/032e_CallDetailRecords.html">032e_CallDetailRecords</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/032x_ComingAttractions.html">032x_ComingAttractions</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/033_00_Intro2PointsOnGraphs.html">033_00_Intro2PointsOnGraphs</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/033_01_OSMtoGraphXUppsalaTiny.html">033_01_OSMtoGraphXUppsalaTiny</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/033_02_OSMtoGraphX_LT.html">033_02_OSMtoGraphX_LT</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/033_03_LT_PageRank.html">033_03_LT_PageRank</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/034_01_MapMatching_with_GeoMatch_UppsalaTiny.html">034_01_MapMatching_with_GeoMatch_UppsalaTiny</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/034_02_MapMatching_on_a_Graph_UppsalaTiny.html">034_02_MapMatching_on_a_Graph_UppsalaTiny</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/034_03_MapMatching_on_a_Graph_LT.html">034_03_MapMatching_on_a_Graph_LT</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/034_04_MapMatching_on_a_G1_LT.html">034_04_MapMatching_on_a_G1_LT</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/034_05DistributionOfStates.html">034_05DistributionOfStates</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/034_06SimulatingArrivalTimesNHPP_Inversion.html">034_06SimulatingArrivalTimesNHPP_Inversion</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/035_01_Arcgis_coordinates_transformation.html">035_01_Arcgis_coordinates_transformation</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/035_02_Segmentation_municipalities_Magellan.html" class="active">035_02_Segmentation_municipalities_Magellan</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/035_03_Visualization_municipalities.html">035_03_Visualization_municipalities</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/035_04_MapMatching_intersections.html">035_04_MapMatching_intersections</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/035_05_UndirectedG0.html">035_05_UndirectedG0</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/035_06_ConnectedComponent_PageRank.html">035_06_ConnectedComponent_PageRank</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_5-sds-2-x-geo/035_07_PoissonRegression.html">035_07_PoissonRegression</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">sds-3.x/ScaDaMaLe</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<p>ScaDaMaLe Course <a href="https://lamastex.github.io/scalable-data-science/sds/3/x/">site</a> and <a href="https://lamastex.github.io/ScaDaMaLe/index.html">book</a></p>
</div>
<div class="cell markdown">
<h2 id="segmentation-of-lithuania-by-municipalities-using-magellan"><a class="header" href="#segmentation-of-lithuania-by-municipalities-using-magellan">Segmentation of Lithuania by municipalities using Magellan</a></h2>
<p>Virginia Jimenez Mohedano (<a href="https://www.linkedin.com/in/virginiajimenezmohedano/">LinkedIn</a>) and Raazesh Sainudiin (<a href="https://www.linkedin.com/in/raazesh-sainudiin-45955845/">LinkedIn</a>).</p>
<pre><code>This project was supported by UAB SENSMETRY through a Data Science Thesis Internship 
between 2022-01-17 and 2022-06-05 to Virginia J.M. and 
Databricks University Alliance with infrastructure credits from AWS to 
Raazesh Sainudiin, Department of Mathematics, Uppsala University, Sweden.
</code></pre>
<p>2022, Uppsala, Sweden</p>
</div>
<div class="cell markdown">
<h2 id="instructions"><a class="header" href="#instructions">Instructions</a></h2>
<ol>
<li>Clone the Magellan repository from <a href="https://github.com/rahulbsw/magellan.git">https://github.com/rahulbsw/magellan.git</a>.</li>
<li>Build the jar and get it into your local machine.</li>
<li>In Databricks choose <em>Create -&gt; Library</em> and upload the packaged jar.</li>
<li>Create a spark 2.4.5 Scala 2.11 cluster with the uploaded Magellan library installed or if you are already running a cluster and installed the uploaded library to it you have to detach and re-attach any notebook currently using that cluster.</li>
</ol>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import magellan.Point 
import org.apache.spark.sql.functions.udf
import org.apache.spark.sql.functions._
import org.apache.spark.sql.magellan.dsl.expressions._
val toPointUDF = udf{(x:Double,y:Double) =&gt; Point(x,y) }
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import magellan.Point
import org.apache.spark.sql.functions.udf
import org.apache.spark.sql.functions._
import org.apache.spark.sql.magellan.dsl.expressions._
toPointUDF: org.apache.spark.sql.expressions.UserDefinedFunction = UserDefinedFunction(&lt;function2&gt;,org.apache.spark.sql.types.PointUDT@36ebe9ff,Some(List(DoubleType, DoubleType)))
</code></pre>
</div>
</div>
<div class="cell markdown">
<h2 id="car-accidents-in-lithuania"><a class="header" href="#car-accidents-in-lithuania">Car Accidents in Lithuania</a></h2>
</div>
<div class="cell markdown">
<p>After downloading the data (see lasts cells of the notebook), we expect to have the following files in distributed file system (dbfs):</p>
<ul>
<li><code>LTcar_reprojected.csv</code> is the file with the data crashes from LT.</li>
<li><code>municipalities.geojson</code> is the geojson file containing LT municipalities.</li>
</ul>
</div>
<div class="cell markdown">
<p>First five lines or rows of the crash data containing: ID, Lon, Lat, timestamp</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//sc.textFile(&quot;dbfs:/datasets/magellan/LTcar_reprojected.csv&quot;).take(1).foreach(println)
</code></pre>
</div>
<div class="cell markdown">
<p>The output of the above command with IDs and locations anonymised is as follows:</p>
<pre><code>id,latitude,longitude,timestamp
LT20xyABCDEF,55.xxxxxx,21.yyyyyy,20xy-mm-dd hh:20:00.000+01:00
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">case class CrashRecord(id: String, timestamp: String, point: Point)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>defined class CrashRecord
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Load accident data and transform latitude and longitude to Magellan's Point</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import org.apache.spark.sql.types._
import org.apache.spark.sql.functions._
val crashes = spark.read.format(&quot;csv&quot;).option(&quot;header&quot;, &quot;true&quot;).option(&quot;inferSchema&quot;, &quot;true&quot;).load(&quot;dbfs:/datasets/magellan/LTcar_reprojected.csv&quot;).toDF()
val crashes_with_points = crashes.select(col(&quot;id&quot;), col(&quot;timestamp&quot;), col(&quot;longitude&quot;).cast(DoubleType), col(&quot;latitude&quot;).cast(DoubleType)).withColumn(&quot;point&quot;, toPointUDF($&quot;longitude&quot;, $&quot;latitude&quot;)).drop(&quot;latitude&quot;, &quot;longitude&quot;).filter(col(&quot;timeStamp&quot;).isNotNull.as[CrashRecord])
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import org.apache.spark.sql.types._
import org.apache.spark.sql.functions._
crashes: org.apache.spark.sql.DataFrame = [id: string, latitude: double ... 2 more fields]
crashes_with_points: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [id: string, timestamp: timestamp ... 1 more field]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//crashes.show(1)
</code></pre>
</div>
<div class="cell markdown">
<p>The output of the above command with IDs and locations anonymised is as follows:</p>
<pre><code>+------------+---------+---------+-------------------+
|          id| latitude|longitude|          timestamp|
+------------+---------+---------+-------------------+
|LT20xyABCDEF|55.xxxxxx|21.yyyyyy|20xy-mm-dd hh:20:00|
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//crashes_with_points.show(1,false)
</code></pre>
</div>
<div class="cell markdown">
<p>The output of the above command with IDs and locations anonymised is as follows:</p>
<pre><code>+------------+-------------------+---------------------------+
|id          |timestamp          |point                      |
+------------+-------------------+---------------------------+
|LT20xyABCDEF|20xy-mm-dd hh:20:00|Point(21.yyyyyy, 55.xxxxxx)|
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val crashRecordCount = crashes_with_points.count() // how many crash records?
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>crashRecordCount: Long = 11945
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>The geojson format can spatially describe vector features: <code>points</code>, <code>lines</code>, and <code>polygons</code>, representing, for example, water wells, rivers, and lakes. Each item usually has <code>attributes</code> that describe it, such as name or temperature.</p>
</div>
<div class="cell code" execution_count="1" scrolled="auto">
<div class="output execute_result html_result" execution_count="1">
<iframe 
 src="https://en.wikipedia.org/wiki/GeoJSON"
 width="95%" height="400"
 sandbox>
  <p>
    <a href="http://spark.apache.org/docs/latest/index.html">
      Fallback link for browsers that, unlikely, don't support frames
    </a>
  </p>
</iframe>
</div>
</div>
<div class="cell markdown">
<p>The name of the municipality in the metadata is &quot;name&quot; so let's keep only that one.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val municipalities = sqlContext.read.format(&quot;magellan&quot;)
                                   .option(&quot;type&quot;, &quot;geojson&quot;)
                                   .load(&quot;dbfs:/datasets/magellan/municipalities.geojson&quot;)
                                   .filter($&quot;polygon&quot;.isNotNull)
                                   .select($&quot;polygon&quot;, $&quot;metadata&quot;(&quot;name&quot;) as &quot;municipality&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>municipalities: org.apache.spark.sql.DataFrame = [polygon: polygon, municipality: string]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">municipalities.count()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res41: Long = 60
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="true">
<pre><code class="language-scala">municipalities.show(100)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+--------------------+--------------------+
|             polygon|        municipality|
+--------------------+--------------------+
|magellan.Polygon@...|Visagino savivaldybė|
|magellan.Polygon@...|Ignalinos rajono ...|
|magellan.Polygon@...|Zarasų rajono sav...|
|magellan.Polygon@...|Vilkaviškio rajon...|
|magellan.Polygon@...|Šakių rajono savi...|
|magellan.Polygon@...|Utenos rajono sav...|
|magellan.Polygon@...|Švenčionių rajono...|
|magellan.Polygon@...|Šiaulių miesto sa...|
|magellan.Polygon@...|Panevėžio miesto ...|
|magellan.Polygon@...|Elektrėnų savival...|
|magellan.Polygon@...|Vilniaus miesto s...|
|magellan.Polygon@...|Marijampolės savi...|
|magellan.Polygon@...|Kazlų Rūdos saviv...|
|magellan.Polygon@...|Kalvarijos saviva...|
|magellan.Polygon@...|Kauno rajono savi...|
|magellan.Polygon@...|Vilniaus rajono s...|
|magellan.Polygon@...| Pagėgių savivaldybė|
|magellan.Polygon@...|Molėtų rajono sav...|
|magellan.Polygon@...|Anykščių rajono s...|
|magellan.Polygon@...|Klaipėdos miesto ...|
|magellan.Polygon@...|Šalčininkų rajono...|
|magellan.Polygon@...|Širvintų rajono s...|
|magellan.Polygon@...|Trakų rajono savi...|
|magellan.Polygon@...|Palangos miesto s...|
|magellan.Polygon@...|Kretingos rajono ...|
|magellan.Polygon@...|Ukmergės rajono s...|
|magellan.Polygon@...|Panevėžio rajono ...|
|magellan.Polygon@...|Kauno miesto savi...|
|magellan.Polygon@...|Druskininkų saviv...|
|magellan.Polygon@...|Varėnos rajono sa...|
|magellan.Polygon@...|Neringos savivaldybė|
|magellan.Polygon@...|Lazdijų rajono sa...|
|magellan.Polygon@...|Alytaus rajono sa...|
|magellan.Polygon@...|Alytaus miesto sa...|
|magellan.Polygon@...|Rokiškio rajono s...|
|magellan.Polygon@...|Biržų rajono savi...|
|magellan.Polygon@...|Kupiškio rajono s...|
|magellan.Polygon@...| Rietavo savivaldybė|
|magellan.Polygon@...|Pasvalio rajono s...|
|magellan.Polygon@...|Šilutės rajono sa...|
|magellan.Polygon@...|Skuodo rajono sav...|
|magellan.Polygon@...|Klaipėdos rajono ...|
|magellan.Polygon@...|Mažeikių rajono s...|
|magellan.Polygon@...|Pakruojo rajono s...|
|magellan.Polygon@...|Joniškio rajono s...|
|magellan.Polygon@...|Šiaulių rajono sa...|
|magellan.Polygon@...|Akmenės rajono sa...|
|magellan.Polygon@...|Radviliškio rajon...|
|magellan.Polygon@...|Kelmės rajono sav...|
|magellan.Polygon@...|Prienų rajono sav...|
|magellan.Polygon@...|Plungės rajono sa...|
|magellan.Polygon@...|Telšių rajono sav...|
|magellan.Polygon@...|Jonavos rajono sa...|
|magellan.Polygon@...|Raseinių rajono s...|
|magellan.Polygon@...|Tauragės rajono s...|
|magellan.Polygon@...|Kaišiadorių rajon...|
|magellan.Polygon@...|Šilalės rajono sa...|
|magellan.Polygon@...|Kėdainių rajono s...|
|magellan.Polygon@...|Jurbarko rajono s...|
|magellan.Polygon@...|Birštono savivaldybė|
+--------------------+--------------------+
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//If we have the same coordinates system, next cell should not be empty
//The geojson file are presented in the WGS84 coordinate system
</code></pre>
</div>
<div class="cell markdown">
<p>Join the accidents with the municipalities.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val joined = municipalities
            .join(crashes_with_points)
            .where($&quot;point&quot; within $&quot;polygon&quot;)
            .select($&quot;id&quot;, $&quot;timestamp&quot;, $&quot;municipality&quot;, $&quot;point&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>joined: org.apache.spark.sql.DataFrame = [id: string, timestamp: timestamp ... 2 more fields]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//joined.show(1,false)
</code></pre>
</div>
<div class="cell markdown">
<p>The output of the above command with IDs and locations anonymised is as follows:</p>
<pre><code>+------------+-------------------+--------------------+---------------------------+
|id          |timestamp          |municipality        |point                      |
+------------+-------------------+--------------------+---------------------------+
|LT20xyABCDEF|2019-09-08 20:10:00|Visagino savivaldybė|Point(26.xxxxxx, 55.yyyyy) |
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val crashes_in_municipalities = joined.count() 
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>crashes_in_municipalities: Long = 11937
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">crashRecordCount - crashes_in_municipalities // records not in the neighbourhood geojson file
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res45: Long = 8
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val municipality_count = joined
  .groupBy($&quot;municipality&quot;)
  .agg(countDistinct(&quot;id&quot;).as(&quot;acc_count&quot;))
  .orderBy(col(&quot;acc_count&quot;).desc)

municipality_count.show(5,false)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+----------------------------+---------+
|municipality                |acc_count|
+----------------------------+---------+
|Vilniaus miesto savivaldybė |2356     |
|Kauno miesto savivaldybė    |1461     |
|Klaipėdos miesto savivaldybė|733      |
|Panevėžio miesto savivaldybė|592      |
|Šiaulių miesto savivaldybė  |468      |
+----------------------------+---------+
only showing top 5 rows

municipality_count: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [municipality: string, acc_count: bigint]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val municipality_count_freq = municipality_count.withColumn(&quot;frequency&quot;, col(&quot;acc_count&quot;)/crashes_in_municipalities)
municipality_count_freq.show(10,false)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+----------------------------+---------+--------------------+
|municipality                |acc_count|frequency           |
+----------------------------+---------+--------------------+
|Vilniaus miesto savivaldybė |2356     |0.19736952333082014 |
|Kauno miesto savivaldybė    |1461     |0.12239256094496105 |
|Klaipėdos miesto savivaldybė|733      |0.061405713328306945|
|Panevėžio miesto savivaldybė|592      |0.04959370025969674 |
|Šiaulių miesto savivaldybė  |468      |0.039205830610706205|
|Vilniaus rajono savivaldybė |430      |0.03602245120214459 |
|Kauno rajono savivaldybė    |347      |0.02906928038870738 |
|Klaipėdos rajono savivaldybė|289      |0.02421043813353439 |
|Panevėžio rajono savivaldybė|280      |0.02345647985255927 |
|Šiaulių rajono savivaldybė  |214      |0.01792745245874173 |
+----------------------------+---------+--------------------+
only showing top 10 rows

municipality_count_freq: org.apache.spark.sql.DataFrame = [municipality: string, acc_count: bigint ... 1 more field]
</code></pre>
</div>
</div>
<div class="cell markdown">
<h4 id="save-the-frequency-of-accidents-in-each-municipality"><a class="header" href="#save-the-frequency-of-accidents-in-each-municipality">Save the frequency of accidents in each municipality</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">municipality_count_freq.select(&quot;municipality&quot;,&quot;frequency&quot;).write.format(&quot;csv&quot;).option(&quot;header&quot;, true).save(&quot;dbfs:/datasets/lithuania/municipalities_freq.csv&quot;)
</code></pre>
</div>
<div class="cell markdown">
<h3 id="use-the-municipalities-population-to-normalize-the-accidents"><a class="header" href="#use-the-municipalities-population-to-normalize-the-accidents">Use the municipalities' population to normalize the accidents.</a></h3>
</div>
<div class="cell markdown">
<p>Download most updated population data from https://www.registrucentras.lt/p/853 and upload it</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val municipality_pop = spark.read.format(&quot;csv&quot;).option(&quot;delimiter&quot;,&quot;;&quot;).option(&quot;header&quot;, &quot;true&quot;).option(&quot;inferSchema&quot;, &quot;true&quot;).load(&quot;dbfs:/datasets/lithuania/population.csv&quot;).toDF()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>municipality_pop: org.apache.spark.sql.DataFrame = [municipality: string, population: int]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">municipality_pop.show()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+--------------------+----------+
|        municipality|population|
+--------------------+----------+
|Akmenės rajono sa...|     20597|
|Alytaus miesto sa...|     53920|
|Alytaus rajono sa...|     28170|
|Anykščių rajono s...|     24619|
|Birštono savivaldybė|      4425|
|Biržų rajono savi...|     25141|
|Druskininkų saviv...|     21282|
|Elektrėnų savival...|     25903|
|Ignalinos rajono ...|     15495|
|Jonavos rajono sa...|     43564|
|Joniškio rajono s...|     22234|
|Jurbarko rajono s...|     27145|
|Kaišiadorių rajon...|     29746|
|Kalvarijos saviva...|     10737|
|Kauno miesto savi...|    313503|
|Kauno rajono savi...|    105032|
|Kazlų Rūdos saviv...|     11621|
|Kelmės rajono sav...|     27513|
|Klaipėdos miesto ...|    165710|
|Klaipėdos rajono ...|     67232|
+--------------------+----------+
only showing top 20 rows
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val municipality_count_pop = municipality_count.join(municipality_pop, municipality_count.col(&quot;municipality&quot;) === municipality_pop.col(&quot;municipality&quot;)).withColumn(&quot;acc_by_pop&quot;, col(&quot;acc_count&quot;)/col(&quot;population&quot;)).drop(municipality_pop.col(&quot;municipality&quot;))
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>municipality_count_pop: org.apache.spark.sql.DataFrame = [municipality: string, acc_count: bigint ... 2 more fields]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">municipality_count_pop.show()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>+--------------------+---------+----------+--------------------+
|        municipality|acc_count|population|          acc_by_pop|
+--------------------+---------+----------+--------------------+
|Vilniaus miesto s...|     2356|    592389|0.003977116388049069|
|Kauno miesto savi...|     1461|    313503| 0.00466024248571784|
|Klaipėdos miesto ...|      733|    165710|0.004423390260092...|
|Panevėžio miesto ...|      592|     91221|0.006489733723594348|
|Šiaulių miesto sa...|      468|    111289| 0.00420526736694552|
|Vilniaus rajono s...|      430|    108948|0.003946837023167015|
|Kauno rajono savi...|      347|    105032|0.003303755046081194|
|Klaipėdos rajono ...|      289|     67232|0.004298548310328415|
|Panevėžio rajono ...|      280|     38639|0.007246564352079505|
|Šiaulių rajono sa...|      214|     43923|0.004872162648270837|
|Šilutės rajono sa...|      196|     42330|0.004630285849279471|
|Plungės rajono sa...|      185|     35804|0.005167020444643056|
|Raseinių rajono s...|      175|     32598|0.005368427510890238|
|Telšių rajono sav...|      170|     42883|0.003964274887484551|
|Jonavos rajono sa...|      168|     43564|0.003856395188687...|
|Kėdainių rajono s...|      167|     49360|0.003383306320907...|
|Tauragės rajono s...|      165|     41256|0.003999418266433973|
|Marijampolės savi...|      162|     57937| 0.00279614063551789|
|Alytaus miesto sa...|      161|     53920|0.002985905044510386|
|Trakų rajono savi...|      160|     35864|0.004461298237787196|
+--------------------+---------+----------+--------------------+
only showing top 20 rows
</code></pre>
</div>
</div>
<div class="cell markdown">
<h4 id="save-the-accidents-normalized-by-population"><a class="header" href="#save-the-accidents-normalized-by-population">Save the accidents normalized by population</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">municipality_count_pop.select(&quot;municipality&quot;,&quot;acc_by_pop&quot;).write.format(&quot;csv&quot;).option(&quot;header&quot;, true).save(&quot;dbfs:/datasets/lithuania/municipalities_pop.csv&quot;)
</code></pre>
</div>
<div class="cell markdown">
<h1 id="step-0-downloading-datasets-and-load-into-dbfs"><a class="header" href="#step-0-downloading-datasets-and-load-into-dbfs">Step 0: Downloading datasets and load into dbfs</a></h1>
<ul>
<li>get the accident data</li>
<li>get the Lithuanian municipality data</li>
</ul>
</div>
<div class="cell markdown">
<h3 id="getting-crash-data"><a class="header" href="#getting-crash-data">Getting crash data</a></h3>
<h4 id="this-only-needs-to-be-done-once-per-shard"><a class="header" href="#this-only-needs-to-be-done-once-per-shard">(This only needs to be done once per shard!)</a></h4>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">dbutils.fs.cp(&quot;dbfs:/FileStore/tables/ltcar_reprojected.csv&quot;, &quot;dbfs:/datasets/magellan/LTcar_reprojected.csv&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res5: Boolean = true
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;dbfs:/datasets/magellan/&quot;))
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>path</th>
<th>name</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dbfs:/datasets/magellan/LT_adm/</td>
<td>LT_adm/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/magellan/LTbhd/</td>
<td>LTbhd/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/magellan/LTcar_locations.csv</td>
<td>LTcar_locations.csv</td>
<td>706938.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/magellan/LTcar_reprojected.csv</td>
<td>LTcar_reprojected.csv</td>
<td>752891.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/magellan/SFNbhd/</td>
<td>SFNbhd/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/magellan/all.tsv</td>
<td>all.tsv</td>
<td>6.0947802e7</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell markdown">
<h3 id="getting-lithuanian-administrative-divisions-data"><a class="header" href="#getting-lithuanian-administrative-divisions-data">Getting Lithuanian Administrative Divisions Data</a></h3>
<p>Second-level Administrative Divisions, Lithuania, 2015</p>
<p>Data from https://github.com/seporaitis/lt-geojson</p>
</div>
<div class="cell code" execution_count="1" scrolled="true">
<pre><code class="language-sh">wget https://raw.githubusercontent.com/seporaitis/lt-geojson/master/geojson/municipalities.geojson
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>--2022-04-18 15:00:50--  https://raw.githubusercontent.com/seporaitis/lt-geojson/master/geojson/municipalities.geojson
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.110.133, 185.199.111.133, 185.199.108.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.110.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 9590686 (9.1M) [text/plain]
Saving to: ‘municipalities.geojson’

     0K .......... .......... .......... .......... ..........  0% 4.35M 2s
    50K .......... .......... .......... .......... ..........  1% 4.09M 2s
   100K .......... .......... .......... .......... ..........  1% 4.50M 2s
   150K .......... .......... .......... .......... ..........  2% 18.0M 2s
   200K .......... .......... .......... .......... ..........  2% 34.7M 1s
   250K .......... .......... .......... .......... ..........  3% 7.08M 1s
   300K .......... .......... .......... .......... ..........  3% 45.2M 1s
   350K .......... .......... .......... .......... ..........  4% 31.9M 1s
   400K .......... .......... .......... .......... ..........  4% 59.6M 1s
   450K .......... .......... .......... .......... ..........  5% 32.0M 1s
   500K .......... .......... .......... .......... ..........  5% 10.7M 1s
   550K .......... .......... .......... .......... ..........  6% 19.9M 1s
   600K .......... .......... .......... .......... ..........  6% 67.7M 1s
   650K .......... .......... .......... .......... ..........  7% 80.4M 1s
   700K .......... .......... .......... .......... ..........  8% 79.2M 1s
   750K .......... .......... .......... .......... ..........  8% 96.1M 1s
   800K .......... .......... .......... .......... ..........  9%  238M 1s
   850K .......... .......... .......... .......... ..........  9% 81.1M 1s
   900K .......... .......... .......... .......... .......... 10% 80.0M 1s
   950K .......... .......... .......... .......... .......... 10% 75.5M 1s
  1000K .......... .......... .......... .......... .......... 11% 12.4M 1s
  1050K .......... .......... .......... .......... .......... 11% 87.6M 0s
  1100K .......... .......... .......... .......... .......... 12%  118M 0s
  1150K .......... .......... .......... .......... .......... 12% 27.7M 0s
  1200K .......... .......... .......... .......... .......... 13%  164M 0s
  1250K .......... .......... .......... .......... .......... 13%  239M 0s
  1300K .......... .......... .......... .......... .......... 14% 95.0M 0s
  1350K .......... .......... .......... .......... .......... 14% 91.8M 0s
  1400K .......... .......... .......... .......... .......... 15%  114M 0s
  1450K .......... .......... .......... .......... .......... 16%  160M 0s
  1500K .......... .......... .......... .......... .......... 16%  203M 0s
  1550K .......... .......... .......... .......... .......... 17%  167M 0s
  1600K .......... .......... .......... .......... .......... 17% 74.5M 0s
  1650K .......... .......... .......... .......... .......... 18% 73.9M 0s
  1700K .......... .......... .......... .......... .......... 18% 60.7M 0s
  1750K .......... .......... .......... .......... .......... 19% 59.0M 0s
  1800K .......... .......... .......... .......... .......... 19%  142M 0s
  1850K .......... .......... .......... .......... .......... 20%  235M 0s
  1900K .......... .......... .......... .......... .......... 20%  141M 0s
  1950K .......... .......... .......... .......... .......... 21%  138M 0s
  2000K .......... .......... .......... .......... .......... 21%  214M 0s
  2050K .......... .......... .......... .......... .......... 22% 31.2M 0s
  2100K .......... .......... .......... .......... .......... 22% 85.9M 0s
  2150K .......... .......... .......... .......... .......... 23% 91.3M 0s
  2200K .......... .......... .......... .......... .......... 24% 96.5M 0s
  2250K .......... .......... .......... .......... .......... 24% 88.7M 0s
  2300K .......... .......... .......... .......... .......... 25% 58.4M 0s
  2350K .......... .......... .......... .......... .......... 25% 59.8M 0s
  2400K .......... .......... .......... .......... .......... 26%  137M 0s
  2450K .......... .......... .......... .......... .......... 26%  123M 0s
  2500K .......... .......... .......... .......... .......... 27%  117M 0s
  2550K .......... .......... .......... .......... .......... 27%  107M 0s
  2600K .......... .......... .......... .......... .......... 28%  135M 0s
  2650K .......... .......... .......... .......... .......... 28% 47.2M 0s
  2700K .......... .......... .......... .......... .......... 29% 83.0M 0s
  2750K .......... .......... .......... .......... .......... 29%  102M 0s
  2800K .......... .......... .......... .......... .......... 30%  151M 0s
  2850K .......... .......... .......... .......... .......... 30%  135M 0s
  2900K .......... .......... .......... .......... .......... 31% 68.8M 0s
  2950K .......... .......... .......... .......... .......... 32% 59.0M 0s
  3000K .......... .......... .......... .......... .......... 32% 4.71M 0s
  3050K .......... .......... .......... .......... .......... 33% 92.0M 0s
  3100K .......... .......... .......... .......... .......... 33% 96.4M 0s
  3150K .......... .......... .......... .......... .......... 34% 69.4M 0s
  3200K .......... .......... .......... .......... .......... 34% 81.6M 0s
  3250K .......... .......... .......... .......... .......... 35% 70.3M 0s
  3300K .......... .......... .......... .......... .......... 35% 43.2M 0s
  3350K .......... .......... .......... .......... .......... 36% 29.4M 0s
  3400K .......... .......... .......... .......... .......... 36% 40.3M 0s
  3450K .......... .......... .......... .......... .......... 37% 33.6M 0s
  3500K .......... .......... .......... .......... .......... 37% 34.9M 0s
  3550K .......... .......... .......... .......... .......... 38% 30.7M 0s
  3600K .......... .......... .......... .......... .......... 38% 32.4M 0s
  3650K .......... .......... .......... .......... .......... 39% 35.3M 0s
  3700K .......... .......... .......... .......... .......... 40% 33.2M 0s
  3750K .......... .......... .......... .......... .......... 40% 38.5M 0s
  3800K .......... .......... .......... .......... .......... 41% 78.5M 0s
  3850K .......... .......... .......... .......... .......... 41% 81.5M 0s
  3900K .......... .......... .......... .......... .......... 42% 95.4M 0s
  3950K .......... .......... .......... .......... .......... 42% 91.4M 0s
  4000K .......... .......... .......... .......... .......... 43%  133M 0s
  4050K .......... .......... .......... .......... .......... 43%  147M 0s
  4100K .......... .......... .......... .......... .......... 44%  116M 0s
  4150K .......... .......... .......... .......... .......... 44%  113M 0s
  4200K .......... .......... .......... .......... .......... 45%  139M 0s
  4250K .......... .......... .......... .......... .......... 45%  138M 0s
  4300K .......... .......... .......... .......... .......... 46%  139M 0s
  4350K .......... .......... .......... .......... .......... 46%  122M 0s
  4400K .......... .......... .......... .......... .......... 47%  144M 0s
  4450K .......... .......... .......... .......... .......... 48%  131M 0s
  4500K .......... .......... .......... .......... .......... 48%  148M 0s
  4550K .......... .......... .......... .......... .......... 49% 44.5M 0s
  4600K .......... .......... .......... .......... .......... 49% 83.8M 0s
  4650K .......... .......... .......... .......... .......... 50%  132M 0s
  4700K .......... .......... .......... .......... .......... 50%  144M 0s
  4750K .......... .......... .......... .......... .......... 51% 86.2M 0s
  4800K .......... .......... .......... .......... .......... 51% 72.0M 0s
  4850K .......... .......... .......... .......... .......... 52% 78.3M 0s
  4900K .......... .......... .......... .......... .......... 52% 99.6M 0s
  4950K .......... .......... .......... .......... .......... 53% 70.1M 0s
  5000K .......... .......... .......... .......... .......... 53% 83.3M 0s
  5050K .......... .......... .......... .......... .......... 54% 78.1M 0s
  5100K .......... .......... .......... .......... .......... 54% 98.5M 0s
  5150K .......... .......... .......... .......... .......... 55% 91.9M 0s
  5200K .......... .......... .......... .......... .......... 56%  142M 0s
  5250K .......... .......... .......... .......... .......... 56% 98.5M 0s
  5300K .......... .......... .......... .......... .......... 57% 86.3M 0s
  5350K .......... .......... .......... .......... .......... 57% 78.9M 0s
  5400K .......... .......... .......... .......... .......... 58%  138M 0s
  5450K .......... .......... .......... .......... .......... 58%  144M 0s
  5500K .......... .......... .......... .......... .......... 59% 92.9M 0s
  5550K .......... .......... .......... .......... .......... 59%  122M 0s
  5600K .......... .......... .......... .......... .......... 60%  138M 0s
  5650K .......... .......... .......... .......... .......... 60%  154M 0s
  5700K .......... .......... .......... .......... .......... 61% 6.75M 0s
  5750K .......... .......... .......... .......... .......... 61% 52.2M 0s
  5800K .......... .......... .......... .......... .......... 62%  106M 0s
  5850K .......... .......... .......... .......... .......... 62% 60.6M 0s
  5900K .......... .......... .......... .......... .......... 63%  127M 0s
  5950K .......... .......... .......... .......... .......... 64%  124M 0s
  6000K .......... .......... .......... .......... .......... 64%  140M 0s
  6050K .......... .......... .......... .......... .......... 65%  149M 0s
  6100K .......... .......... .......... .......... .......... 65%  145M 0s
  6150K .......... .......... .......... .......... .......... 66%  140M 0s
  6200K .......... .......... .......... .......... .......... 66%  176M 0s
  6250K .......... .......... .......... .......... .......... 67%  150M 0s
  6300K .......... .......... .......... .......... .......... 67% 62.8M 0s
  6350K .......... .......... .......... .......... .......... 68% 58.0M 0s
  6400K .......... .......... .......... .......... .......... 68% 39.4M 0s
  6450K .......... .......... .......... .......... .......... 69% 37.8M 0s
  6500K .......... .......... .......... .......... .......... 69% 36.9M 0s
  6550K .......... .......... .......... .......... .......... 70% 33.7M 0s
  6600K .......... .......... .......... .......... .......... 71% 39.3M 0s
  6650K .......... .......... .......... .......... .......... 71% 37.6M 0s
  6700K .......... .......... .......... .......... .......... 72% 38.0M 0s
  6750K .......... .......... .......... .......... .......... 72% 34.2M 0s
  6800K .......... .......... .......... .......... .......... 73% 36.5M 0s
  6850K .......... .......... .......... .......... .......... 73% 36.0M 0s
  6900K .......... .......... .......... .......... .......... 74% 36.5M 0s
  6950K .......... .......... .......... .......... .......... 74% 34.3M 0s
  7000K .......... .......... .......... .......... .......... 75% 41.6M 0s
  7050K .......... .......... .......... .......... .......... 75% 37.5M 0s
  7100K .......... .......... .......... .......... .......... 76% 36.0M 0s
  7150K .......... .......... .......... .......... .......... 76% 26.1M 0s
  7200K .......... .......... .......... .......... .......... 77% 38.3M 0s
  7250K .......... .......... .......... .......... .......... 77% 37.2M 0s
  7300K .......... .......... .......... .......... .......... 78% 36.5M 0s
  7350K .......... .......... .......... .......... .......... 79% 13.5M 0s
  7400K .......... .......... .......... .......... .......... 79% 34.9M 0s
  7450K .......... .......... .......... .......... .......... 80% 38.6M 0s
  7500K .......... .......... .......... .......... .......... 80% 39.5M 0s
  7550K .......... .......... .......... .......... .......... 81% 37.1M 0s
  7600K .......... .......... .......... .......... .......... 81% 40.0M 0s
  7650K .......... .......... .......... .......... .......... 82% 36.9M 0s
  7700K .......... .......... .......... .......... .......... 82% 42.2M 0s
  7750K .......... .......... .......... .......... .......... 83% 38.9M 0s
  7800K .......... .......... .......... .......... .......... 83% 45.4M 0s
  7850K .......... .......... .......... .......... .......... 84% 46.0M 0s
  7900K .......... .......... .......... .......... .......... 84% 40.2M 0s
  7950K .......... .......... .......... .......... .......... 85% 39.9M 0s
  8000K .......... .......... .......... .......... .......... 85% 45.1M 0s
  8050K .......... .......... .......... .......... .......... 86% 45.3M 0s
  8100K .......... .......... .......... .......... .......... 87% 44.6M 0s
  8150K .......... .......... .......... .......... .......... 87% 79.8M 0s
  8200K .......... .......... .......... .......... .......... 88%  120M 0s
  8250K .......... .......... .......... .......... .......... 88%  118M 0s
  8300K .......... .......... .......... .......... .......... 89%  118M 0s
  8350K .......... .......... .......... .......... .......... 89%  103M 0s
  8400K .......... .......... .......... .......... .......... 90%  118M 0s
  8450K .......... .......... .......... .......... .......... 90% 96.8M 0s
  8500K .......... .......... .......... .......... .......... 91%  102M 0s
  8550K .......... .......... .......... .......... .......... 91% 87.7M 0s
  8600K .......... .......... .......... .......... .......... 92%  107M 0s
  8650K .......... .......... .......... .......... .......... 92%  123M 0s
  8700K .......... .......... .......... .......... .......... 93%  116M 0s
  8750K .......... .......... .......... .......... .......... 93%  111M 0s
  8800K .......... .......... .......... .......... .......... 94%  116M 0s
  8850K .......... .......... .......... .......... .......... 95%  190M 0s
  8900K .......... .......... .......... .......... .......... 95% 87.6M 0s
  8950K .......... .......... .......... .......... .......... 96%  100M 0s
  9000K .......... .......... .......... .......... .......... 96%  116M 0s
  9050K .......... .......... .......... .......... .......... 97%  123M 0s
  9100K .......... .......... .......... .......... .......... 97%  126M 0s
  9150K .......... .......... .......... .......... .......... 98%  210M 0s
  9200K .......... .......... .......... .......... .......... 98%  237M 0s
  9250K .......... .......... .......... .......... .......... 99%  242M 0s
  9300K .......... .......... .......... .......... .......... 99%  240M 0s
  9350K .......... .....                                      100%  146M=0.2s

2022-04-18 15:00:51 (44.9 MB/s) - ‘municipalities.geojson’ saved [9590686/9590686]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="true">
<pre><code class="language-python"># Reading and processing geojson. Removing @relations (fails for some reason and not needed)

import json

# municipalities / Savivaldybės
municipalities = json.load(open(&quot;municipalities.geojson&quot;, 'r'))

list_to_remove = []
i = 0
for feature in municipalities['features']:
  municipalities['features'][i][&quot;properties&quot;].pop(&quot;relations&quot;, None)
  municipalities['features'][i][&quot;properties&quot;].pop(&quot;@relations&quot;, None)

  i+=1
  
for feature in municipalities['features']:
  for property in feature[&quot;properties&quot;]:
    print(property)
    
with open(&quot;municipalities.geojson&quot;, 'w') as outfile:
    json.dump(municipalities, outfile)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:bat-smg
name:de
name:en
name:fi
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
is_in:country_code
name
name:be
name:be-tarask
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:lt
name:pl
name:ru
type
website
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:bat-smg
name:ca
name:de
name:en
name:fi
name:fr
name:it
name:lt
name:lv
name:nn
name:pl
name:ru
name:sco
name:zh
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:en
name:lt
name:lv
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:bat-smg
name:ca
name:de
name:en
name:fr
name:it
name:lt
name:lv
name:pl
name:ru
name:zh
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:bat-smg
name:de
name:el
name:en
name:fi
name:fr
name:it
name:lt
name:lv
name:nl
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:ca
name:de
name:en
name:eo
name:es
name:fi
name:fr
name:it
name:ka
name:lt
name:lv
name:pl
name:ru
name:zh
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
is_in:country_code
name
name:de
name:fi
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:en
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:en
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
is_in:country_code
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:et
name:lt
name:pl
name:ru
type
website
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:bat-smg
name:de
name:en
name:fi
name:fr
name:it
name:ka
name:lt
name:lv
name:nl
name:no
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
source
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:en
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:en
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:bat-smg
name:ca
name:de
name:en
name:es
name:fi
name:fr
name:it
name:ka
name:lt
name:lv
name:pl
name:ru
name:zh
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:lv
name:pl
name:ru
name:ur
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:bat-smg
name:ca
name:de
name:es
name:et
name:fi
name:fr
name:he
name:it
name:ka
name:lmo
name:lt
name:lv
name:pl
name:ru
name:ur
name:zh
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:lt
name:pl
name:ru
type
wikidata
wikipedia
@id
ISO3166-2
admin_level
boundary
name
name:de
name:el
name:en
name:et
name:fi
name:fr
name:it
name:lt
name:lv
name:nl
name:no
name:pl
name:ru
type
wikidata
wikipedia
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
@id
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">dbutils.fs.cp(&quot;file:/databricks/driver/municipalities.geojson&quot;, &quot;dbfs:/datasets/magellan/&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res36: Boolean = true
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="end-of-step-0-downloading-and-putting-data-in-dbfs"><a class="header" href="#end-of-step-0-downloading-and-putting-data-in-dbfs">End of Step 0: downloading and putting data in dbfs</a></h3>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../contents/000_5-sds-2-x-geo/035_01_Arcgis_coordinates_transformation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../contents/000_5-sds-2-x-geo/035_03_Visualization_municipalities.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../contents/000_5-sds-2-x-geo/035_01_Arcgis_coordinates_transformation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../contents/000_5-sds-2-x-geo/035_03_Visualization_municipalities.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
