<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>026_TweetCollector - sds-3.x/ScaDaMaLe</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../scroll-mdbook-outputs.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/024_SparkStreamingIntro.html">024_SparkStreamingIntro</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/025_0_getTwitterDeveloperCredentials.html">025_0_getTwitterDeveloperCredentials</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/025_a_extendedTwitterUtils2run.html">025_a_extendedTwitterUtils2run</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/025_b_TTTDFfunctions.html">025_b_TTTDFfunctions</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/025_c_extendedTwitterUtils2runWithLangs.html">025_c_extendedTwitterUtils2runWithLangs</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/026_TweetCollector.html" class="active">026_TweetCollector</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/027_TweetCollectorTrackAndFollow.html">027_TweetCollectorTrackAndFollow</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/028_TweetHashtagCount.html">028_TweetHashtagCount</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/029_TweetLanguageClassifier.html">029_TweetLanguageClassifier</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/029_Viz_0_TwitterInteractiveVizualisations.html">029_Viz_0_TwitterInteractiveVizualisations</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/029_Viz_1_GraphNetworkTimeline.html">029_Viz_1_GraphNetworkTimeline</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/029_Viz_2_CoSENSE_EmotionalDimensions.html">029_Viz_2_CoSENSE_EmotionalDimensions</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/029_Viz_x_VizGraphFunction.html">029_Viz_x_VizGraphFunction</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/029_Viz_x_VizNetworkFunction.html">029_Viz_x_VizNetworkFunction</a></li><li class="chapter-item expanded affix "><a href="../../contents/000_3-sds-3-x-st/029_Viz_x_VizTimelineFunction.html">029_Viz_x_VizTimelineFunction</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">sds-3.x/ScaDaMaLe</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="cell markdown">
<p>ScaDaMaLe Course <a href="https://lamastex.github.io/scalable-data-science/sds/3/x/">site</a> and <a href="https://lamastex.github.io/ScaDaMaLe/index.html">book</a></p>
</div>
<div class="cell markdown">
<h1 id="tweet-streaming-collector"><a class="header" href="#tweet-streaming-collector">Tweet Streaming Collector</a></h1>
<p>Let us build a system to collect live tweets using Spark streaming.</p>
<p>Here are the main steps in this notebook:</p>
<ul>
<li>let's collect from the public twitter stream and write to DBFS as json strings in a boiler-plate manner to understand the componets better.</li>
<li>Then we will turn the collector into a function and use it</li>
<li>Finally we will use some DataFrame-based pipelines to convert the raw tweets into other structured content.</li>
</ul>
<p>Note that capturing tweets from the public streams for free using Twitter's Streaming API has some caveats. We are supposed to have access to a uniformly random sample of roughly 1% of all Tweets across the globe, but what's exactly available in the sample from the full twitter social media network, i.e. <em>all</em> status updates in the planet, for such free collection is not exactly known in terms of sub-sampling strategies like starification layers, etc. This latter is Twitter's proprietary information. However, we are supposed to be able to assume that it is indeed a random sample of roughly 1% of all tweets.</p>
</div>
<div class="cell markdown">
<p>We will call extendedTwitterUtils notebook from here.</p>
<p>But <strong>first install</strong> the following libraries from maven central and attach to this cluster:</p>
<ul>
<li>gson with maven coordinates <code>com.google.code.gson:gson:2.8.6</code></li>
<li>twitter4j-examples with maven coordinates <code>org.twitter4j:twitter4j-examples:4.0.7</code></li>
</ul>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-run">&quot;./025_a_extendedTwitterUtils2run&quot;
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell code" execution_count="1" scrolled="false">
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import twitter4j._
import twitter4j.auth.Authorization
import twitter4j.conf.ConfigurationBuilder
import twitter4j.auth.OAuthAuthorization
import org.apache.spark.streaming._
import org.apache.spark.streaming.dstream._
import org.apache.spark.storage.StorageLevel
import org.apache.spark.streaming.receiver.Receiver
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Go to SparkUI and see if a streaming job is already running. If so you need to terminate it before starting a new streaming job. Only one streaming job can be run on the DB CE.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell code" execution_count="1" scrolled="false">
<div class="output execute_result plain_result" execution_count="1">
<pre><code>defined class ExtendedTwitterReceiver
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<div class="output execute_result plain_result" execution_count="1">
<pre><code>defined class ExtendedTwitterInputDStream
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// this will make sure all streaming job in the cluster are stopped
StreamingContext.getActive.foreach{ _.stop(stopSparkContext = false) }
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell code" execution_count="1" scrolled="false">
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import twitter4j.Status
import twitter4j.auth.Authorization
import org.apache.spark.storage.StorageLevel
import org.apache.spark.streaming.StreamingContext
import org.apache.spark.streaming.dstream.{ReceiverInputDStream, DStream}
defined object ExtendedTwitterUtils
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<div class="output execute_result plain_result" execution_count="1">
<pre><code>done running the extendedTwitterUtils2run notebook - ready to stream from twitter
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Let's create a directory in dbfs for storing tweets in the cluster's distributed file system.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val outputDirectoryRoot = &quot;/datasets/tweetsStreamTmp&quot; // output directory
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>outputDirectoryRoot: String = /datasets/tweetsStreamTmp
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">dbutils.fs.mkdirs(&quot;/datasets/tweetsStreamTmp&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res2: Boolean = true
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//display(dbutils.fs.ls(outputDirectoryRoot))
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// to remove a pre-existing directory and start from scratch uncomment next line and evaluate this cell
dbutils.fs.rm(&quot;/datasets/tweetsStreamTmp&quot;, true) 
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res4: Boolean = true
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Capture tweets in every sliding window of <code>slideInterval</code> many milliseconds.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val slideInterval = new Duration(1 * 1000) // 1 * 1000 = 1000 milli-seconds = 1 sec
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>slideInterval: org.apache.spark.streaming.Duration = 1000 ms
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Recall that <strong>Discretized Stream</strong> or <strong>DStream</strong> is the basic abstraction provided by Spark Streaming. It represents a continuous stream of data, either the input data stream received from source, or the processed data stream generated by transforming the input stream. Internally, a DStream is represented by a continuous series of RDDs, which is Spark?s abstraction of an immutable, distributed dataset (see <a href="http://spark.apache.org/docs/latest/programming-guide.html#resilient-distributed-datasets-rdds">Spark Programming Guide</a> for more details). Each RDD in a DStream contains data from a certain interval, as shown in the following figure.</p>
<p><img src="http://spark.apache.org/docs/latest/img/streaming-dstream.png" alt="Spark Streaming" title="Spark Streaming data flow" /></p>
</div>
<div class="cell markdown">
<p>Let's import google's json library next.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import com.google.gson.Gson 
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import com.google.gson.Gson
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Our goal is to take each RDD in the twitter DStream and write it as a json file in our dbfs.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Create a Spark Streaming Context.
val ssc = new StreamingContext(sc, slideInterval)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>ssc: org.apache.spark.streaming.StreamingContext = org.apache.spark.streaming.StreamingContext@7a8fbb86
</code></pre>
</div>
</div>
<div class="cell markdown">
<h2 id="caution"><a class="header" href="#caution">CAUTION</a></h2>
<p>Extracting knowledge from tweets is &quot;easy&quot; using techniques shown here, but one has to take legal responsibility for the use of this knowledge and conform to the rules and policies linked below.</p>
<p>Remeber that the use of twitter itself comes with various strings attached. Read:</p>
<ul>
<li><a href="https://twitter.com/rules">Twitter Rules</a></li>
</ul>
<p>Crucially, the use of the content from twitter by you (as done in this worksheet) comes with some strings. Read:</p>
<ul>
<li><a href="https://dev.twitter.com/overview/terms/agreement-and-policy">Developer Agreement &amp; Policy Twitter Developer Agreement</a></li>
</ul>
<h3 id="enter-your-own-twitter-api-credentials"><a class="header" href="#enter-your-own-twitter-api-credentials">Enter your own Twitter API Credentials.</a></h3>
<ul>
<li>Go to https://apps.twitter.com and look up your Twitter API Credentials, or create an app to create them.</li>
<li>Get your own Twitter API Credentials: <code>consumerKey</code>, <code>consumerSecret</code>, <code>accessToken</code> and <code>accessTokenSecret</code> and enter them in the cell below.</li>
</ul>
<h3 id="ethicallegal-aspects"><a class="header" href="#ethicallegal-aspects">Ethical/Legal Aspects</a></h3>
<p>See Background Readings/Viewings in Project MEP:</p>
<ul>
<li><a href="https://lamastex.github.io/scalable-data-science/sds/research/mep/">https://lamastex.github.io/scalable-data-science/sds/research/mep/</a></li>
</ul>
</div>
<div class="cell markdown">
<h2 id="tweet-collector"><a class="header" href="#tweet-collector">Tweet Collector</a></h2>
<p>There are several steps to make a streaming twitter collector. We will do them one by one so you learn all the components. In the sequel we will make a function out of the various steps.</p>
<h3 id="1-twitter-credentials"><a class="header" href="#1-twitter-credentials">1. Twitter Credentials</a></h3>
<p>First step towards doing your own experiments in twitter is to enter your Twitter API credentials.</p>
<ul>
<li>Go to https://apps.twitter.com and look up your Twitter API Credentials, or create an app to create them.</li>
<li>Run the code in a cell to Enter your own credentials.</li>
</ul>
<pre><code class="language-%scala">// put your own twitter developer credentials below instead of xxx
// instead of the '%run &quot;.../secrets/026_secret_MyTwitterOAuthCredentials&quot;' below
// you need to copy-paste the following code-block with your own Twitter credentials replacing XXXX


// put your own twitter developer credentials below 

import twitter4j.auth.OAuthAuthorization
import twitter4j.conf.ConfigurationBuilder


// These have been regenerated!!! - need to chane them

def myAPIKey       = &quot;XXXX&quot; // APIKey 
def myAPISecret    = &quot;XXXX&quot; // APISecretKey
def myAccessToken          = &quot;XXXX&quot; // AccessToken
def myAccessTokenSecret    = &quot;XXXX&quot; // AccessTokenSecret


System.setProperty(&quot;twitter4j.oauth.consumerKey&quot;, myAPIKey)
System.setProperty(&quot;twitter4j.oauth.consumerSecret&quot;, myAPISecret)
System.setProperty(&quot;twitter4j.oauth.accessToken&quot;, myAccessToken)
System.setProperty(&quot;twitter4j.oauth.accessTokenSecret&quot;, myAccessTokenSecret)

println(&quot;twitter OAuth Credentials loaded&quot;)
</code></pre>
<p>The cell-below will not expose my Twitter API Credentials: <code>myAPIKey</code>, <code>myAPISecret</code>, <code>myAccessToken</code> and <code>myAccessTokenSecret</code>. Use the code above to enter your own credentials in a scala cell.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-run">&quot;Users/raazesh.sainudiin@math.uu.se/scalable-data-science/secrets/026_secret_MyTwitterOAuthCredentials&quot;
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Create a Twitter Stream for the input source. 
val auth = Some(new OAuthAuthorization(new ConfigurationBuilder().build()))
val twitterStream = ExtendedTwitterUtils.createStream(ssc, auth)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>auth: Some[twitter4j.auth.OAuthAuthorization] = Some(OAuthAuthorization{consumerKey='8uN0N9RTLT1viaR811yyG7xwk', consumerSecret='******************************************', oauthToken=AccessToken{screenName='null', userId=4173723312}})
twitterStream: org.apache.spark.streaming.dstream.ReceiverInputDStream[twitter4j.Status] = ExtendedTwitterInputDStream@7f635e6d
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="2-mapping-tweets-to-json"><a class="header" href="#2-mapping-tweets-to-json">2. Mapping Tweets to JSON</a></h3>
<p>Let's map the tweets into <a href="https://en.wikipedia.org/wiki/JSON">JSON</a> formatted string (one tweet per line). We will use Google GSON library for this.</p>
</div>
<div class="cell code" execution_count="1" scrolled="auto">
<div class="output execute_result html_result" execution_count="1">
<iframe 
 src="https://en.wikipedia.org/wiki/JSON"
 width="95%" height="400">
  <p>
    <a href="http://spark.apache.org/docs/latest/index.html">
      Fallback link for browsers that, unlikely, don't support frames
    </a>
  </p>
</iframe>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val twitterStreamJson = twitterStream.map(
                                            x =&gt; { val gson = new Gson();
                                                 val xJson = gson.toJson(x)
                                                 xJson
                                                 }
                                          ) 
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>twitterStreamJson: org.apache.spark.streaming.dstream.DStream[String] = org.apache.spark.streaming.dstream.MappedDStream@b874a46
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<div class="output execute_result plain_result" execution_count="1">
<pre><code>twitter OAuth Credentials loaded
import twitter4j.auth.OAuthAuthorization
import twitter4j.conf.ConfigurationBuilder
import twitter4j.auth.OAuthAuthorization
import twitter4j.conf.ConfigurationBuilder
myAPIKey: String
myAPISecret: String
myAccessToken: String
myAccessTokenSecret: String
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">outputDirectoryRoot
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res8: String = /datasets/tweetsStreamTmp
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">var numTweetsCollected = 0L // track number of tweets collected
val partitionsEachInterval = 1 // This tells the number of partitions in each RDD of tweets in the DStream.

twitterStreamJson.foreachRDD( 
  (rdd, time) =&gt; { // for each RDD in the DStream
      val count = rdd.count()
      if (count &gt; 0) {
        val outputRDD = rdd.repartition(partitionsEachInterval) // repartition as desired
        outputRDD.saveAsTextFile(outputDirectoryRoot + &quot;/tweets_&quot; + time.milliseconds.toString) // save as textfile
        numTweetsCollected += count // update with the latest count
      }
  }
)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>numTweetsCollected: Long = 0
partitionsEachInterval: Int = 1
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="3-start-the-stream"><a class="header" href="#3-start-the-stream">3. Start the Stream</a></h3>
<p>Nothing has actually happened yet.</p>
<p>Let's start the spark streaming context we have created next.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">ssc.start()
</code></pre>
</div>
<div class="cell markdown">
<p>Let's look at the spark UI now and monitor the streaming job in action! Go to <code>Clusters</code> on the left and click on <code>UI</code> and then <code>Streaming</code>.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">numTweetsCollected // number of tweets collected so far
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res11: Long = 468
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Let's try seeing again in a few seconds how many tweets have been collected up to now.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">numTweetsCollected // number of tweets collected so far
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res12: Long = 859
</code></pre>
</div>
</div>
<div class="cell markdown">
<h3 id="4-stop-the-stream"><a class="header" href="#4-stop-the-stream">4. Stop the Stream</a></h3>
<p>Note that you could easilt fill up disk space!!!</p>
<p>So let's stop the streaming job next.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">ssc.stop(stopSparkContext = false) // gotto stop soon!!!
</code></pre>
</div>
<div class="cell markdown">
<p>Let's make sure that the <code>Streaming</code> UI is not active in the <code>Clusters</code> <code>UI</code>.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">StreamingContext.getActive.foreach { _.stop(stopSparkContext = false) } // extra cautious stopping of all active streaming contexts
</code></pre>
</div>
<div class="cell markdown">
<h3 id="5-examine-collected-tweets"><a class="header" href="#5-examine-collected-tweets">5. Examine Collected Tweets</a></h3>
<p>Next let's examine what was saved in dbfs.</p>
</div>
<div class="cell code" execution_count="1" scrolled="true">
<pre><code class="language-scala">display(dbutils.fs.ls(outputDirectoryRoot))
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>path</th>
<th>name</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867067000/</td>
<td>tweets_1605867067000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867068000/</td>
<td>tweets_1605867068000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867069000/</td>
<td>tweets_1605867069000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867070000/</td>
<td>tweets_1605867070000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867071000/</td>
<td>tweets_1605867071000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867072000/</td>
<td>tweets_1605867072000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867073000/</td>
<td>tweets_1605867073000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867074000/</td>
<td>tweets_1605867074000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867075000/</td>
<td>tweets_1605867075000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867076000/</td>
<td>tweets_1605867076000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867077000/</td>
<td>tweets_1605867077000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867078000/</td>
<td>tweets_1605867078000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867079000/</td>
<td>tweets_1605867079000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867080000/</td>
<td>tweets_1605867080000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867081000/</td>
<td>tweets_1605867081000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867082000/</td>
<td>tweets_1605867082000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867083000/</td>
<td>tweets_1605867083000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867084000/</td>
<td>tweets_1605867084000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867085000/</td>
<td>tweets_1605867085000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867086000/</td>
<td>tweets_1605867086000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867087000/</td>
<td>tweets_1605867087000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867088000/</td>
<td>tweets_1605867088000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867089000/</td>
<td>tweets_1605867089000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867090000/</td>
<td>tweets_1605867090000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867091000/</td>
<td>tweets_1605867091000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867092000/</td>
<td>tweets_1605867092000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867093000/</td>
<td>tweets_1605867093000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867094000/</td>
<td>tweets_1605867094000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867095000/</td>
<td>tweets_1605867095000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867096000/</td>
<td>tweets_1605867096000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867097000/</td>
<td>tweets_1605867097000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867098000/</td>
<td>tweets_1605867098000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867099000/</td>
<td>tweets_1605867099000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867100000/</td>
<td>tweets_1605867100000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867101000/</td>
<td>tweets_1605867101000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867102000/</td>
<td>tweets_1605867102000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867103000/</td>
<td>tweets_1605867103000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867104000/</td>
<td>tweets_1605867104000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867105000/</td>
<td>tweets_1605867105000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867106000/</td>
<td>tweets_1605867106000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867107000/</td>
<td>tweets_1605867107000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867108000/</td>
<td>tweets_1605867108000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867109000/</td>
<td>tweets_1605867109000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867110000/</td>
<td>tweets_1605867110000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867111000/</td>
<td>tweets_1605867111000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867112000/</td>
<td>tweets_1605867112000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867113000/</td>
<td>tweets_1605867113000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867114000/</td>
<td>tweets_1605867114000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867115000/</td>
<td>tweets_1605867115000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867116000/</td>
<td>tweets_1605867116000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867117000/</td>
<td>tweets_1605867117000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867118000/</td>
<td>tweets_1605867118000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867119000/</td>
<td>tweets_1605867119000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867120000/</td>
<td>tweets_1605867120000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867121000/</td>
<td>tweets_1605867121000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867122000/</td>
<td>tweets_1605867122000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867123000/</td>
<td>tweets_1605867123000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867124000/</td>
<td>tweets_1605867124000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867125000/</td>
<td>tweets_1605867125000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867126000/</td>
<td>tweets_1605867126000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867127000/</td>
<td>tweets_1605867127000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867128000/</td>
<td>tweets_1605867128000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867129000/</td>
<td>tweets_1605867129000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867130000/</td>
<td>tweets_1605867130000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867131000/</td>
<td>tweets_1605867131000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867132000/</td>
<td>tweets_1605867132000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867133000/</td>
<td>tweets_1605867133000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867134000/</td>
<td>tweets_1605867134000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867135000/</td>
<td>tweets_1605867135000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867136000/</td>
<td>tweets_1605867136000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867137000/</td>
<td>tweets_1605867137000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867138000/</td>
<td>tweets_1605867138000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867139000/</td>
<td>tweets_1605867139000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867140000/</td>
<td>tweets_1605867140000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867141000/</td>
<td>tweets_1605867141000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867142000/</td>
<td>tweets_1605867142000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867143000/</td>
<td>tweets_1605867143000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867144000/</td>
<td>tweets_1605867144000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867145000/</td>
<td>tweets_1605867145000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867146000/</td>
<td>tweets_1605867146000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867147000/</td>
<td>tweets_1605867147000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867148000/</td>
<td>tweets_1605867148000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867149000/</td>
<td>tweets_1605867149000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867150000/</td>
<td>tweets_1605867150000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867151000/</td>
<td>tweets_1605867151000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867152000/</td>
<td>tweets_1605867152000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867153000/</td>
<td>tweets_1605867153000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867154000/</td>
<td>tweets_1605867154000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867155000/</td>
<td>tweets_1605867155000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867156000/</td>
<td>tweets_1605867156000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867157000/</td>
<td>tweets_1605867157000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867158000/</td>
<td>tweets_1605867158000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867159000/</td>
<td>tweets_1605867159000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867160000/</td>
<td>tweets_1605867160000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867161000/</td>
<td>tweets_1605867161000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867162000/</td>
<td>tweets_1605867162000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867163000/</td>
<td>tweets_1605867163000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867164000/</td>
<td>tweets_1605867164000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867165000/</td>
<td>tweets_1605867165000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867166000/</td>
<td>tweets_1605867166000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867167000/</td>
<td>tweets_1605867167000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867168000/</td>
<td>tweets_1605867168000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867169000/</td>
<td>tweets_1605867169000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867170000/</td>
<td>tweets_1605867170000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867171000/</td>
<td>tweets_1605867171000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867172000/</td>
<td>tweets_1605867172000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867173000/</td>
<td>tweets_1605867173000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867174000/</td>
<td>tweets_1605867174000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867175000/</td>
<td>tweets_1605867175000/</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val tweetsDir = outputDirectoryRoot+&quot;/tweets_1605867068000/&quot; // use an existing file, may have to rename folder based on output above!
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>tweetsDir: String = /datasets/tweetsStreamTmp/tweets_1605867068000/
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(tweetsDir)) 
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>path</th>
<th>name</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867068000/_SUCCESS</td>
<td>_SUCCESS</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/tweets_1605867068000/part-00000</td>
<td>part-00000</td>
<td>122395.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">sc.textFile(tweetsDir+&quot;part-00000&quot;).count()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res17: Long = 31
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val outJson = sqlContext.read.json(tweetsDir+&quot;part-00000&quot;)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>outJson: org.apache.spark.sql.DataFrame = [contributorsIDs: array&lt;string&gt;, createdAt: string ... 26 more fields]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="true">
<pre><code class="language-scala">outJson.printSchema()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>root
 |-- contributorsIDs: array (nullable = true)
 |    |-- element: string (containsNull = true)
 |-- createdAt: string (nullable = true)
 |-- currentUserRetweetId: long (nullable = true)
 |-- displayTextRangeEnd: long (nullable = true)
 |-- displayTextRangeStart: long (nullable = true)
 |-- favoriteCount: long (nullable = true)
 |-- hashtagEntities: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- end: long (nullable = true)
 |    |    |-- start: long (nullable = true)
 |    |    |-- text: string (nullable = true)
 |-- id: long (nullable = true)
 |-- inReplyToScreenName: string (nullable = true)
 |-- inReplyToStatusId: long (nullable = true)
 |-- inReplyToUserId: long (nullable = true)
 |-- isFavorited: boolean (nullable = true)
 |-- isPossiblySensitive: boolean (nullable = true)
 |-- isRetweeted: boolean (nullable = true)
 |-- isTruncated: boolean (nullable = true)
 |-- lang: string (nullable = true)
 |-- mediaEntities: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- displayURL: string (nullable = true)
 |    |    |-- end: long (nullable = true)
 |    |    |-- expandedURL: string (nullable = true)
 |    |    |-- id: long (nullable = true)
 |    |    |-- mediaURL: string (nullable = true)
 |    |    |-- mediaURLHttps: string (nullable = true)
 |    |    |-- sizes: struct (nullable = true)
 |    |    |    |-- 0: struct (nullable = true)
 |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |-- 1: struct (nullable = true)
 |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |-- 2: struct (nullable = true)
 |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |-- 3: struct (nullable = true)
 |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |-- width: long (nullable = true)
 |    |    |-- start: long (nullable = true)
 |    |    |-- type: string (nullable = true)
 |    |    |-- url: string (nullable = true)
 |    |    |-- videoAspectRatioHeight: long (nullable = true)
 |    |    |-- videoAspectRatioWidth: long (nullable = true)
 |    |    |-- videoDurationMillis: long (nullable = true)
 |    |    |-- videoVariants: array (nullable = true)
 |    |    |    |-- element: string (containsNull = true)
 |-- quotedStatus: struct (nullable = true)
 |    |-- contributorsIDs: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- createdAt: string (nullable = true)
 |    |-- currentUserRetweetId: long (nullable = true)
 |    |-- displayTextRangeEnd: long (nullable = true)
 |    |-- displayTextRangeStart: long (nullable = true)
 |    |-- favoriteCount: long (nullable = true)
 |    |-- hashtagEntities: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- id: long (nullable = true)
 |    |-- inReplyToScreenName: string (nullable = true)
 |    |-- inReplyToStatusId: long (nullable = true)
 |    |-- inReplyToUserId: long (nullable = true)
 |    |-- isFavorited: boolean (nullable = true)
 |    |-- isPossiblySensitive: boolean (nullable = true)
 |    |-- isRetweeted: boolean (nullable = true)
 |    |-- isTruncated: boolean (nullable = true)
 |    |-- lang: string (nullable = true)
 |    |-- mediaEntities: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- displayURL: string (nullable = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- expandedURL: string (nullable = true)
 |    |    |    |-- id: long (nullable = true)
 |    |    |    |-- mediaURL: string (nullable = true)
 |    |    |    |-- mediaURLHttps: string (nullable = true)
 |    |    |    |-- sizes: struct (nullable = true)
 |    |    |    |    |-- 0: struct (nullable = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |    |-- 1: struct (nullable = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |    |-- 2: struct (nullable = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |    |-- 3: struct (nullable = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- type: string (nullable = true)
 |    |    |    |-- url: string (nullable = true)
 |    |    |    |-- videoAspectRatioHeight: long (nullable = true)
 |    |    |    |-- videoAspectRatioWidth: long (nullable = true)
 |    |    |    |-- videoDurationMillis: long (nullable = true)
 |    |    |    |-- videoVariants: array (nullable = true)
 |    |    |    |    |-- element: string (containsNull = true)
 |    |-- place: struct (nullable = true)
 |    |    |-- boundingBoxCoordinates: array (nullable = true)
 |    |    |    |-- element: array (containsNull = true)
 |    |    |    |    |-- element: struct (containsNull = true)
 |    |    |    |    |    |-- latitude: double (nullable = true)
 |    |    |    |    |    |-- longitude: double (nullable = true)
 |    |    |-- boundingBoxType: string (nullable = true)
 |    |    |-- country: string (nullable = true)
 |    |    |-- countryCode: string (nullable = true)
 |    |    |-- fullName: string (nullable = true)
 |    |    |-- id: string (nullable = true)
 |    |    |-- name: string (nullable = true)
 |    |    |-- placeType: string (nullable = true)
 |    |    |-- url: string (nullable = true)
 |    |-- quotedStatusId: long (nullable = true)
 |    |-- retweetCount: long (nullable = true)
 |    |-- source: string (nullable = true)
 |    |-- symbolEntities: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- text: string (nullable = true)
 |    |-- urlEntities: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- user: struct (nullable = true)
 |    |    |-- createdAt: string (nullable = true)
 |    |    |-- description: string (nullable = true)
 |    |    |-- descriptionURLEntities: array (nullable = true)
 |    |    |    |-- element: string (containsNull = true)
 |    |    |-- favouritesCount: long (nullable = true)
 |    |    |-- followersCount: long (nullable = true)
 |    |    |-- friendsCount: long (nullable = true)
 |    |    |-- id: long (nullable = true)
 |    |    |-- isContributorsEnabled: boolean (nullable = true)
 |    |    |-- isDefaultProfile: boolean (nullable = true)
 |    |    |-- isDefaultProfileImage: boolean (nullable = true)
 |    |    |-- isFollowRequestSent: boolean (nullable = true)
 |    |    |-- isGeoEnabled: boolean (nullable = true)
 |    |    |-- isProtected: boolean (nullable = true)
 |    |    |-- isVerified: boolean (nullable = true)
 |    |    |-- listedCount: long (nullable = true)
 |    |    |-- location: string (nullable = true)
 |    |    |-- name: string (nullable = true)
 |    |    |-- profileBackgroundColor: string (nullable = true)
 |    |    |-- profileBackgroundImageUrl: string (nullable = true)
 |    |    |-- profileBackgroundImageUrlHttps: string (nullable = true)
 |    |    |-- profileBackgroundTiled: boolean (nullable = true)
 |    |    |-- profileBannerImageUrl: string (nullable = true)
 |    |    |-- profileImageUrl: string (nullable = true)
 |    |    |-- profileImageUrlHttps: string (nullable = true)
 |    |    |-- profileLinkColor: string (nullable = true)
 |    |    |-- profileSidebarBorderColor: string (nullable = true)
 |    |    |-- profileSidebarFillColor: string (nullable = true)
 |    |    |-- profileTextColor: string (nullable = true)
 |    |    |-- profileUseBackgroundImage: boolean (nullable = true)
 |    |    |-- screenName: string (nullable = true)
 |    |    |-- showAllInlineMedia: boolean (nullable = true)
 |    |    |-- statusesCount: long (nullable = true)
 |    |    |-- translator: boolean (nullable = true)
 |    |    |-- url: string (nullable = true)
 |    |    |-- utcOffset: long (nullable = true)
 |    |-- userMentionEntities: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- id: long (nullable = true)
 |    |    |    |-- name: string (nullable = true)
 |    |    |    |-- screenName: string (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |-- quotedStatusId: long (nullable = true)
 |-- quotedStatusPermalink: struct (nullable = true)
 |    |-- displayURL: string (nullable = true)
 |    |-- end: long (nullable = true)
 |    |-- expandedURL: string (nullable = true)
 |    |-- start: long (nullable = true)
 |    |-- url: string (nullable = true)
 |-- retweetCount: long (nullable = true)
 |-- retweetedStatus: struct (nullable = true)
 |    |-- contributorsIDs: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- createdAt: string (nullable = true)
 |    |-- currentUserRetweetId: long (nullable = true)
 |    |-- displayTextRangeEnd: long (nullable = true)
 |    |-- displayTextRangeStart: long (nullable = true)
 |    |-- favoriteCount: long (nullable = true)
 |    |-- hashtagEntities: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- text: string (nullable = true)
 |    |-- id: long (nullable = true)
 |    |-- inReplyToScreenName: string (nullable = true)
 |    |-- inReplyToStatusId: long (nullable = true)
 |    |-- inReplyToUserId: long (nullable = true)
 |    |-- isFavorited: boolean (nullable = true)
 |    |-- isPossiblySensitive: boolean (nullable = true)
 |    |-- isRetweeted: boolean (nullable = true)
 |    |-- isTruncated: boolean (nullable = true)
 |    |-- lang: string (nullable = true)
 |    |-- mediaEntities: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- displayURL: string (nullable = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- expandedURL: string (nullable = true)
 |    |    |    |-- id: long (nullable = true)
 |    |    |    |-- mediaURL: string (nullable = true)
 |    |    |    |-- mediaURLHttps: string (nullable = true)
 |    |    |    |-- sizes: struct (nullable = true)
 |    |    |    |    |-- 0: struct (nullable = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |    |-- 1: struct (nullable = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |    |-- 2: struct (nullable = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |    |-- 3: struct (nullable = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- resize: long (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- type: string (nullable = true)
 |    |    |    |-- url: string (nullable = true)
 |    |    |    |-- videoAspectRatioHeight: long (nullable = true)
 |    |    |    |-- videoAspectRatioWidth: long (nullable = true)
 |    |    |    |-- videoDurationMillis: long (nullable = true)
 |    |    |    |-- videoVariants: array (nullable = true)
 |    |    |    |    |-- element: string (containsNull = true)
 |    |-- quotedStatusId: long (nullable = true)
 |    |-- retweetCount: long (nullable = true)
 |    |-- source: string (nullable = true)
 |    |-- symbolEntities: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- text: string (nullable = true)
 |    |-- urlEntities: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- displayURL: string (nullable = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- expandedURL: string (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- url: string (nullable = true)
 |    |-- user: struct (nullable = true)
 |    |    |-- createdAt: string (nullable = true)
 |    |    |-- description: string (nullable = true)
 |    |    |-- descriptionURLEntities: array (nullable = true)
 |    |    |    |-- element: string (containsNull = true)
 |    |    |-- favouritesCount: long (nullable = true)
 |    |    |-- followersCount: long (nullable = true)
 |    |    |-- friendsCount: long (nullable = true)
 |    |    |-- id: long (nullable = true)
 |    |    |-- isContributorsEnabled: boolean (nullable = true)
 |    |    |-- isDefaultProfile: boolean (nullable = true)
 |    |    |-- isDefaultProfileImage: boolean (nullable = true)
 |    |    |-- isFollowRequestSent: boolean (nullable = true)
 |    |    |-- isGeoEnabled: boolean (nullable = true)
 |    |    |-- isProtected: boolean (nullable = true)
 |    |    |-- isVerified: boolean (nullable = true)
 |    |    |-- listedCount: long (nullable = true)
 |    |    |-- location: string (nullable = true)
 |    |    |-- name: string (nullable = true)
 |    |    |-- profileBackgroundColor: string (nullable = true)
 |    |    |-- profileBackgroundImageUrl: string (nullable = true)
 |    |    |-- profileBackgroundImageUrlHttps: string (nullable = true)
 |    |    |-- profileBackgroundTiled: boolean (nullable = true)
 |    |    |-- profileBannerImageUrl: string (nullable = true)
 |    |    |-- profileImageUrl: string (nullable = true)
 |    |    |-- profileImageUrlHttps: string (nullable = true)
 |    |    |-- profileLinkColor: string (nullable = true)
 |    |    |-- profileSidebarBorderColor: string (nullable = true)
 |    |    |-- profileSidebarFillColor: string (nullable = true)
 |    |    |-- profileTextColor: string (nullable = true)
 |    |    |-- profileUseBackgroundImage: boolean (nullable = true)
 |    |    |-- screenName: string (nullable = true)
 |    |    |-- showAllInlineMedia: boolean (nullable = true)
 |    |    |-- statusesCount: long (nullable = true)
 |    |    |-- translator: boolean (nullable = true)
 |    |    |-- url: string (nullable = true)
 |    |    |-- utcOffset: long (nullable = true)
 |    |-- userMentionEntities: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- id: long (nullable = true)
 |    |    |    |-- name: string (nullable = true)
 |    |    |    |-- screenName: string (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |-- source: string (nullable = true)
 |-- symbolEntities: array (nullable = true)
 |    |-- element: string (containsNull = true)
 |-- text: string (nullable = true)
 |-- urlEntities: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- displayURL: string (nullable = true)
 |    |    |-- end: long (nullable = true)
 |    |    |-- expandedURL: string (nullable = true)
 |    |    |-- start: long (nullable = true)
 |    |    |-- url: string (nullable = true)
 |-- user: struct (nullable = true)
 |    |-- createdAt: string (nullable = true)
 |    |-- description: string (nullable = true)
 |    |-- descriptionURLEntities: array (nullable = true)
 |    |    |-- element: string (containsNull = true)
 |    |-- favouritesCount: long (nullable = true)
 |    |-- followersCount: long (nullable = true)
 |    |-- friendsCount: long (nullable = true)
 |    |-- id: long (nullable = true)
 |    |-- isContributorsEnabled: boolean (nullable = true)
 |    |-- isDefaultProfile: boolean (nullable = true)
 |    |-- isDefaultProfileImage: boolean (nullable = true)
 |    |-- isFollowRequestSent: boolean (nullable = true)
 |    |-- isGeoEnabled: boolean (nullable = true)
 |    |-- isProtected: boolean (nullable = true)
 |    |-- isVerified: boolean (nullable = true)
 |    |-- listedCount: long (nullable = true)
 |    |-- location: string (nullable = true)
 |    |-- name: string (nullable = true)
 |    |-- profileBackgroundColor: string (nullable = true)
 |    |-- profileBackgroundImageUrl: string (nullable = true)
 |    |-- profileBackgroundImageUrlHttps: string (nullable = true)
 |    |-- profileBackgroundTiled: boolean (nullable = true)
 |    |-- profileBannerImageUrl: string (nullable = true)
 |    |-- profileImageUrl: string (nullable = true)
 |    |-- profileImageUrlHttps: string (nullable = true)
 |    |-- profileLinkColor: string (nullable = true)
 |    |-- profileSidebarBorderColor: string (nullable = true)
 |    |-- profileSidebarFillColor: string (nullable = true)
 |    |-- profileTextColor: string (nullable = true)
 |    |-- profileUseBackgroundImage: boolean (nullable = true)
 |    |-- screenName: string (nullable = true)
 |    |-- showAllInlineMedia: boolean (nullable = true)
 |    |-- statusesCount: long (nullable = true)
 |    |-- translator: boolean (nullable = true)
 |    |-- url: string (nullable = true)
 |    |-- utcOffset: long (nullable = true)
 |-- userMentionEntities: array (nullable = true)
 |    |-- element: struct (containsNull = true)
 |    |    |-- end: long (nullable = true)
 |    |    |-- id: long (nullable = true)
 |    |    |-- name: string (nullable = true)
 |    |    |-- screenName: string (nullable = true)
 |    |    |-- start: long (nullable = true)
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//outJson.select(&quot;id&quot;,&quot;text&quot;).show(false) // output not displayed to comply with Twitter Developer rules
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//display(outJson)  // output not displayed to comply with Twitter Developer rules
</code></pre>
</div>
<div class="cell markdown">
<p>Now, let's be good at house-keeping and clean-up the unnecessary data in dbfs, our distributed file system (in databricks).</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// to remove a pre-existing directory and start from scratch uncomment next line and evaluate this cell
dbutils.fs.rm(outputDirectoryRoot, true) 
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res24: Boolean = true
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Clearly there is a lot one can do with tweets!</p>
<p>Enspecially, after you can get a few more primitives under your belt from the following areas:</p>
<ul>
<li>Natural Language Processing (MLlib, beyond word counts of course),</li>
<li>Distributed vertex programming (Graph Frames, which you already know), and</li>
<li>Scalable geospatial computing with location data on open street maps (roughly a third of tweets are geo-enabled with Latitude and Longitude of the tweet location) - we will get into this.</li>
</ul>
</div>
<div class="cell markdown">
<h2 id="method-for-spark-streaming-collector"><a class="header" href="#method-for-spark-streaming-collector">Method for Spark Streaming Collector</a></h2>
<p>Let's try to throw the bits and bobs of code in the above 5 steps into a method called <code>streamFunc</code> for simplicity and modularity.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">import com.google.gson.Gson 
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._

val outputDirectoryRoot = &quot;/datasets/tweetsStreamTmp&quot; // output directory
val batchInterval = 1 // in minutes
val timeoutJobLength =  batchInterval * 5

var newContextCreated = false
var numTweetsCollected = 0L // track number of tweets collected
//val conf = new SparkConf().setAppName(&quot;TrackedTweetCollector&quot;).setMaster(&quot;local&quot;)
// This is the function that creates the SteamingContext and sets up the Spark Streaming job.
def streamFunc(): StreamingContext = {
  // Create a Spark Streaming Context.
  val ssc = new StreamingContext(sc, Minutes(batchInterval))
  // Create the OAuth Twitter credentials 
  val auth = Some(new OAuthAuthorization(new ConfigurationBuilder().build()))
  // Create a Twitter Stream for the input source.  
  val twitterStream = ExtendedTwitterUtils.createStream(ssc, auth)
  // Transform the discrete RDDs into JSON
  val twitterStreamJson = twitterStream.map(x =&gt; { val gson = new Gson();
                                                 val xJson = gson.toJson(x)
                                                 xJson
                                               }) 
  // take care
  val partitionsEachInterval = 1 // This tells the number of partitions in each RDD of tweets in the DStream.
  
  // what we want done with each discrete RDD tuple: (rdd, time)
  twitterStreamJson.foreachRDD((rdd, time) =&gt; { // for each filtered RDD in the DStream
      val count = rdd.count()
      if (count &gt; 0) {
        val outputRDD = rdd.repartition(partitionsEachInterval) // repartition as desired
        // to write to parquet directly in append mode in one directory per 'time'------------       
        val outputDF = outputRDD.toDF(&quot;tweetAsJsonString&quot;)
        // get some time fields from current `.Date()`
        val year = (new java.text.SimpleDateFormat(&quot;yyyy&quot;)).format(new java.util.Date())
        val month = (new java.text.SimpleDateFormat(&quot;MM&quot;)).format(new java.util.Date())
        val day = (new java.text.SimpleDateFormat(&quot;dd&quot;)).format(new java.util.Date())
        val hour = (new java.text.SimpleDateFormat(&quot;HH&quot;)).format(new java.util.Date())
        // write to a file with a clear time-based hierarchical directory structure for example
        outputDF.write.mode(SaveMode.Append)
                .parquet(outputDirectoryRoot+ &quot;/&quot;+ year + &quot;/&quot; + month + &quot;/&quot; + day + &quot;/&quot; + hour + &quot;/&quot; + time.milliseconds) 
        // end of writing as parquet file-------------------------------------
        numTweetsCollected += count // update with the latest count
      }
  })
  newContextCreated = true
  ssc
}
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>import com.google.gson.Gson
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._
outputDirectoryRoot: String = /datasets/tweetsStreamTmp
batchInterval: Int = 1
timeoutJobLength: Int = 5
newContextCreated: Boolean = false
numTweetsCollected: Long = 0
streamFunc: ()org.apache.spark.streaming.StreamingContext
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// Now just use the function to create a Spark Streaming Context
val ssc = StreamingContext.getActiveOrCreate(streamFunc)
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>ssc: org.apache.spark.streaming.StreamingContext = org.apache.spark.streaming.StreamingContext@400b6153
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// you only need one of these to start
ssc.start()
//ssc.awaitTerminationOrTimeout(timeoutJobLength)
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// this will make sure all streaming job in the cluster are stopped
// but let' run it for a few minutes before stopping it
//StreamingContext.getActive.foreach { _.stop(stopSparkContext = false) } 
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(dbutils.fs.ls(&quot;/datasets/tweetsStreamTmp/2020/11/20/10&quot;)) // outputDirectoryRoot
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>path</th>
<th>name</th>
<th>size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/2020/11/20/10/1605867660000/</td>
<td>1605867660000/</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>dbfs:/datasets/tweetsStreamTmp/2020/11/20/10/1605867720000/</td>
<td>1605867720000/</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>dbfs:/datasets/tweetsStreamTmp/2020/11/20/10/1605867780000/</td>
<td>1605867780000/</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell markdown">
<h2 id="tweet-transmission-tree-tables"><a class="header" href="#tweet-transmission-tree-tables">Tweet Transmission Tree Tables</a></h2>
<p>Next, let us take a quick peek at the notebook <code>./025_b_TTTDFfunctions</code> to see how we have pipelined the JSON tweets into tabular or structured data as DataFrames.</p>
<p>Please see <a href="http://lamastex.org/lmse/mep/src/TweetAnatomyAndTransmissionTree.html">http://lamastex.org/lmse/mep/src/TweetAnatomyAndTransmissionTree.html</a> to understand more deeply.</p>
<p>Note that the fundamental issue here is that we need to define what we exactly mean by a particular type of status update, i.e.:</p>
<ul>
<li>How do we categorize a particular status update, based on the data contained in it, as one of the following?
<ul>
<li>Original Tweet</li>
<li>Retweet</li>
<li>Quoted tweet</li>
<li>retweet of a Quoted Tweet</li>
<li>etc.</li>
</ul>
</li>
</ul>
<p>Answers to the above question are exactly answered by the methods in <code>./025_b_TTTDFfunctions</code>.</p>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-run">&quot;./025_b_TTTDFfunctions&quot;
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell code" execution_count="1" scrolled="false">
</div>
<div class="cell code" execution_count="1" scrolled="false">
<div class="output execute_result plain_result" execution_count="1">
<pre><code>USAGE: val df = tweetsDF2TTTDF(tweetsJsonStringDF2TweetsDF(fromParquetFile2DF(&quot;parquetFileName&quot;)))
                  val df = tweetsDF2TTTDF(tweetsIDLong_JsonStringPairDF2TweetsDF(fromParquetFile2DF(&quot;parquetFileName&quot;)))
                  
import org.apache.spark.sql.types.{StructType, StructField, StringType}
import org.apache.spark.sql.functions._
import org.apache.spark.sql.types._
import org.apache.spark.sql.ColumnName
import org.apache.spark.sql.DataFrame
fromParquetFile2DF: (InputDFAsParquetFilePatternString: String)org.apache.spark.sql.DataFrame
tweetsJsonStringDF2TweetsDF: (tweetsAsJsonStringInputDF: org.apache.spark.sql.DataFrame)org.apache.spark.sql.DataFrame
tweetsIDLong_JsonStringPairDF2TweetsDF: (tweetsAsIDLong_JsonStringInputDF: org.apache.spark.sql.DataFrame)org.apache.spark.sql.DataFrame
tweetsDF2TTTDF: (tweetsInputDF: org.apache.spark.sql.DataFrame)org.apache.spark.sql.DataFrame
tweetsDF2TTTDFWithURLsAndHashtags: (tweetsInputDF: org.apache.spark.sql.DataFrame)org.apache.spark.sql.DataFrame
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<div class="output execute_result plain_result" execution_count="1">
<pre><code>tweetsDF2TTTDFLightWeight: (tweetsInputDF: org.apache.spark.sql.DataFrame)org.apache.spark.sql.DataFrame
tweetsDF2TTTDFWithURLsAndHashtagsLightWeight: (tweetsInputDF: org.apache.spark.sql.DataFrame)org.apache.spark.sql.DataFrame
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">val rawDF = fromParquetFile2DF(&quot;/datasets/tweetsStreamTmp/2020/11/*/*/*/*&quot;) //.cache()
val TTTsDF = tweetsDF2TTTDF(tweetsJsonStringDF2TweetsDF(rawDF)).cache()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>rawDF: org.apache.spark.sql.DataFrame = [tweetAsJsonString: string]
TTTsDF: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [CurrentTweetDate: timestamp, CurrentTwID: bigint ... 35 more fields]
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">TTTsDF.count()
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res34: Long = 14686
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">//display(TTTsDF)  // output not displayed to comply with Twitter Developer rules
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="true">
<pre><code class="language-scala">TTTsDF.printSchema
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>root
 |-- CurrentTweetDate: timestamp (nullable = true)
 |-- CurrentTwID: long (nullable = true)
 |-- lang: string (nullable = true)
 |-- lat: double (nullable = true)
 |-- lon: double (nullable = true)
 |-- CreationDateOfOrgTwInRT: timestamp (nullable = true)
 |-- OriginalTwIDinRT: long (nullable = true)
 |-- CreationDateOfOrgTwInQT: timestamp (nullable = true)
 |-- OriginalTwIDinQT: long (nullable = true)
 |-- OriginalTwIDinReply: long (nullable = true)
 |-- CPostUserId: long (nullable = true)
 |-- userCreatedAtDate: timestamp (nullable = true)
 |-- OPostUserIdinRT: long (nullable = true)
 |-- OPostUserIdinQT: long (nullable = true)
 |-- OPostUserIdinReply: long (nullable = true)
 |-- CPostUserName: string (nullable = true)
 |-- OPostUserNameinRT: string (nullable = true)
 |-- OPostUserNameinQT: string (nullable = true)
 |-- CPostUserSN: string (nullable = true)
 |-- OPostUserSNinRT: string (nullable = true)
 |-- OPostUserSNinQT: string (nullable = true)
 |-- OPostUserSNinReply: string (nullable = true)
 |-- favouritesCount: long (nullable = true)
 |-- followersCount: long (nullable = true)
 |-- friendsCount: long (nullable = true)
 |-- isVerified: boolean (nullable = true)
 |-- isGeoEnabled: boolean (nullable = true)
 |-- CurrentTweet: string (nullable = true)
 |-- UMentionRTiD: array (nullable = true)
 |    |-- element: long (containsNull = true)
 |-- UMentionRTsN: array (nullable = true)
 |    |-- element: string (containsNull = true)
 |-- UMentionQTiD: array (nullable = true)
 |    |-- element: long (containsNull = true)
 |-- UMentionQTsN: array (nullable = true)
 |    |-- element: string (containsNull = true)
 |-- UMentionASiD: array (nullable = true)
 |    |-- element: long (containsNull = true)
 |-- UMentionASsN: array (nullable = true)
 |    |-- element: string (containsNull = true)
 |-- TweetType: string (nullable = false)
 |-- MentionType: string (nullable = false)
 |-- Weight: long (nullable = false)
</code></pre>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">display(TTTsDF.groupBy($&quot;tweetType&quot;).count().orderBy($&quot;count&quot;.desc))
</code></pre>
<div class="output execute_result tabular_result" execution_count="1">
<table>
<thead>
<tr class="header">
<th>tweetType</th>
<th>count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ReTweet</td>
<td>5956.0</td>
</tr>
<tr class="even">
<td>Reply Tweet</td>
<td>4187.0</td>
</tr>
<tr class="odd">
<td>Original Tweet</td>
<td>3326.0</td>
</tr>
<tr class="even">
<td>Quoted Tweet</td>
<td>754.0</td>
</tr>
<tr class="odd">
<td>Retweet of Quoted Tweet</td>
<td>416.0</td>
</tr>
<tr class="even">
<td>Reply of Quoted Tweet</td>
<td>47.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// this will make sure all streaming job in the cluster are stopped
StreamingContext.getActive.foreach{ _.stop(stopSparkContext = false) } 
</code></pre>
</div>
<div class="cell code" execution_count="1" scrolled="false">
<pre><code class="language-scala">// this will delete what we collected to keep the disk usage tight and tidy
dbutils.fs.rm(outputDirectoryRoot, true) 
</code></pre>
<div class="output execute_result plain_result" execution_count="1">
<pre><code>res40: Boolean = true
</code></pre>
</div>
</div>
<div class="cell markdown">
<h2 id="writing-to-public-clouds"><a class="header" href="#writing-to-public-clouds">Writing to public clouds</a></h2>
<p>Next, let's write the tweets into a scalable commercial cloud storage system in AWS (similarly into Azure blobstore, Google cloud storage, etc ).</p>
<p>We will make sure to write the tweets to AWS's simple storage service or S3, a scalable storage system in the cloud. See <a href="https://aws.amazon.com/s3/">https://aws.amazon.com/s3/</a>.</p>
<p><strong>skip this if you don't have an AWS account</strong>.</p>
<p>But all the main syntactic bits are here for your future convenience :)</p>
<pre><code>// Replace with your AWS S3 credentials
//
// NOTE: Set the access to this notebook appropriately to protect the security of your keys.
// Or you can delete this cell after you run the mount command below once successfully.

val AccessKey = getArgument(&quot;1. ACCESS_KEY&quot;, &quot;REPLACE_WITH_YOUR_ACCESS_KEY&quot;)
val SecretKey = getArgument(&quot;2. SECRET_KEY&quot;, &quot;REPLACE_WITH_YOUR_SECRET_KEY&quot;)
val EncodedSecretKey = SecretKey.replace(&quot;/&quot;, &quot;%2F&quot;)
val AwsBucketName = getArgument(&quot;3. S3_BUCKET&quot;, &quot;REPLACE_WITH_YOUR_S3_BUCKET&quot;)
val MountName = getArgument(&quot;4. MNT_NAME&quot;, &quot;REPLACE_WITH_YOUR_MOUNT_NAME&quot;)
val s3Filename = &quot;tweetDump&quot;
</code></pre>
<p>Now just mount s3 as follows:</p>
<pre><code>dbutils.fs.mount(s&quot;s3a://$AccessKey:$EncodedSecretKey@$AwsBucketName&quot;, s&quot;/mnt/$MountName&quot;)
</code></pre>
<p>Now you can use the <code>dbutils</code> commands freely to access data in the mounted S3.</p>
<pre><code>dbutils.fs.help()
</code></pre>
<p>copying:</p>
<pre><code>// to copy all the tweets to s3
dbutils.fs.cp(&quot;dbfs:/rawTweets&quot;,s&quot;/mnt/$MountName/rawTweetsInS3/&quot;,recurse=true) 
</code></pre>
<p>deleting:</p>
<pre><code>// to remove all the files from s3
dbutils.fs.rm(s&quot;/mnt/$MountName/rawTweetsInS3&quot;,recurse=true) 
</code></pre>
<p>unmounting:</p>
<pre><code>// finally unmount when done - IMPORTANT!
dbutils.fs.unmount(s&quot;/mnt/$MountName&quot;) 
</code></pre>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../contents/000_3-sds-3-x-st/025_c_extendedTwitterUtils2runWithLangs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../contents/000_3-sds-3-x-st/027_TweetCollectorTrackAndFollow.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../contents/000_3-sds-3-x-st/025_c_extendedTwitterUtils2runWithLangs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../contents/000_3-sds-3-x-st/027_TweetCollectorTrackAndFollow.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
